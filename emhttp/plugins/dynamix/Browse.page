Title=""
Tag="home"
Nchan="file_manager"
---
<?PHP
/* Copyright 2005-2025, Lime Technology
 * Copyright 2012-2025, Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>
<?
function dfm_quote($text) {
  return "\"$text\"";
}

function dfm_array($array) {
  return implode(',', array_map('dfm_quote', $array));
}

function validdir($dir) {
  $path = realpath($dir);
  return in_array(explode('/', $path)[1] ?? '', ['mnt','boot']) ? $path : '';
}

$dir     = validdir(htmlspecialchars_decode(rawurldecode($dir)));
[$none,$root,$main,$next,$rest] = my_explode('/', $dir,5);
$dir     = htmlspecialchars(str_replace(['\\', "\n", "\r", "\t"], ['\\\\', '\\n', '\\r', '\\t'], $dir));
$lock    = $root == 'mnt' ? ($main ?: '---') : ($root == 'boot' ? _('flash') : '---');
$isshare = $root == 'mnt' && (!$main || !$next || ($main == 'rootshare' && !$rest));
$editor  = '/boot/config/editor.cfg';

if (!file_exists($editor)) file_put_contents($editor, implode("\n",['','txt','js','php','page','plg','xml','old','bak','log','css']));
?>
<link type="text/css" rel="stylesheet" href="<?autov("/webGui/styles/jquery.filetree.css")?>">
<link type="text/css" rel="stylesheet" href="<?autov("/webGui/styles/jquery.switchbutton.css")?>">

<script src="<?autov("/webGui/javascript/jquery.filetree.js")?>"></script>
<script src="<?autov("/webGui/javascript/jquery.switchbutton.js")?>"></script>
<script>
// General variables
var dir   = "<?=$dir?>";
var table = null;
var thead = null;

function autoscale(value) {
  var unit  = ['B','kB','MB','GB','TB','PB','EB'];
  var base  = value>1?Math.floor(Math.log(value)/Math.log(1000)):0;
  var data  = base<unit.length ? value/Math.pow(1000, base) : 0;
  var scale = data<100?100:10;
  if (data == 0) base = 0;
  return ((Math.round(scale*data)/scale)+' '+unit[base]).replace('.','<?=$display['number'][0]?>')+'/s';
}

function preventFileTreeClose() {
  // Prevent fileTree dropdown from closing when clicking inside the dialog
  // by stopping mousedown events from bubbling to the document handler
  $('.ui-dfm').off('mousedown.dfmFileTree').on('mousedown.dfmFileTree', function(e) {
    e.stopPropagation();
  });
}

function folderContextMenu(id, button) {
  var opts = [];
  context.settings({button:button});
  if (dfm.running) {
    opts.push({text:"_(Job running)_", icon:"fa fa-ban"});
  } else {
    opts.push({header:"_(Action)_"});
    opts.push({text:"_(Delete)_", icon:"fa-trash-o", action:function(e){e.preventDefault();doAction(1,"_(Delete)_",id.dfm_proxy());}});
    opts.push({text:"_(Copy)_", icon:"fa-copy", action:function(e){e.preventDefault();doAction(3,"_(Copy)_",id.dfm_proxy());}});
    opts.push({text:"_(Move)_", icon:"fa-paste", action:function(e){e.preventDefault();doAction(4,"_(Move)_",id.dfm_proxy());}});
<?if (!$isshare):?>
    opts.push({text:"_(Rename)_", icon:"fa-edit", action:function(e){e.preventDefault();doAction(2,"_(Rename)_",id.dfm_proxy());}});
<?endif?>
    opts.push({divider:true});
    opts.push({text:"_(Owner)_", icon:"fa-user-o", action:function(e){e.preventDefault();doAction(11,"_(Change Owner)_",id.dfm_proxy());}});
    opts.push({text:"_(Permission)_", icon:"fa-address-book-o", action:function(e){e.preventDefault();doAction(12,"_(Change Permission)_",id.dfm_proxy());}});
    opts.push({text:"_(Calculate)_", icon:"fa-calculator", action:function(e){e.preventDefault();doAction(14,"_(Calculate Occupied Space)_",id.dfm_proxy());}});
    opts.push({text:"_(Search)_", icon:"fa-search", action:function(e){e.preventDefault();doAction(15,"_(Search)_",id.dfm_proxy());}});
<?if (!$isshare):?>
    opts.push({header:"_(Common)_"});
    opts.push({text:"_(Create)_", icon:"fa-folder-o", action:function(e){e.preventDefault();doAction(0,"_(Create)_",id.dfm_proxy());}});
<?if ($dir):?>
    opts.push({text:"_(Upload)_", icon:"fa-upload", action:function(e){e.preventDefault();$('#dfm_upload').click();}});
<?endif?>
<?endif?>
  }
  context.attach('#'+id, opts);
}

function fileContextMenu(id, button) {
  var opts = [];
  context.settings({button:button});
  if (dfm.running) {
    opts.push({text:"_(Job running)_", icon:"fa fa-ban"});
  } else {
    opts.push({header:"_(Action)_"});
    opts.push({text:"_(Delete)_", icon:"fa-trash-o", action:function(e){e.preventDefault();doAction(6,"_(Delete)_",id.dfm_proxy());}});
    opts.push({text:"_(Copy)_", icon:"fa-copy", action:function(e){e.preventDefault();doAction(8,"_(Copy)_",id.dfm_proxy());}});
    opts.push({text:"_(Move)_", icon:"fa-paste", action:function(e){e.preventDefault();doAction(9,"_(Move)_",id.dfm_proxy());}});
    opts.push({text:"_(Rename)_", icon:"fa-edit", action:function(e){e.preventDefault();doAction(7,"_(Rename)_",id.dfm_proxy());}});
    opts.push({divider:true});
    opts.push({text:"_(Owner)_", icon:"fa-user-o", action:function(e){e.preventDefault();doAction(11,"_(Change Owner)_",id.dfm_proxy());}});
    opts.push({text:"_(Permission)_", icon:"fa-address-book-o", action:function(e){e.preventDefault();doAction(12,"_(Change Permission)_",id.dfm_proxy());}});
    opts.push({text:"_(Download)_", icon:"fa-download", action:function(e){e.preventDefault();doAction(13,"_(Download)_",id.dfm_proxy());}});
<?if (!$isshare):?>
    opts.push({header:"_(Common)_"});
    opts.push({text:"_(Create)_", icon:"fa-folder-o", action:function(e){e.preventDefault();doAction(0,"_(Create)_",id.dfm_proxy());}});
<?if ($dir):?>
    opts.push({text:"_(Upload)_", icon:"fa-upload", action:function(e){e.preventDefault();$('#dfm_upload').click();}});
<?endif?>
<?endif?>
  }
  context.attach('#'+id, opts);
}

function deviceFolderContextMenu(dev, id) {
  var opts = [];
  context.settings({button:'both'});
  if (dfm.running) {
    opts.push({text:"_(Job running)_", icon:"fa fa-ban"});
  } else {
    opts.push({header:dev.split('/')[2]});
    opts.push({text:"_(Delete)_", icon:"fa-trash-o", action:function(e){e.preventDefault();doAction(1,"_(Delete)_",dev);}});
    opts.push({text:"_(Copy)_", icon:"fa-copy", action:function(e){e.preventDefault();doAction(3,"_(Copy)_",dev);}});
    opts.push({text:"_(Move)_", icon:"fa-paste", action:function(e){e.preventDefault();doAction(4,"_(Move)_",dev);}});
    opts.push({divider:true});
    opts.push({text:"_(Calculate)_", icon:"fa-calculator", action:function(e){e.preventDefault();doAction(14,"_(Calculate Occupied Space)_",dev);}});
  }
  context.attach('#device_'+id, opts);
}

function deviceFileContextMenu(dev, id) {
  var opts = [];
  context.settings({button:'both'});
  if (dfm.running) {
    opts.push({text:"_(Job running)_", icon:"fa fa-ban"});
  } else {
    opts.push({header:dev.split('/')[2]});
    opts.push({text:"_(Delete)_", icon:"fa-trash-o", action:function(e){e.preventDefault();doAction(6,"_(Delete)_",dev);}});
    opts.push({text:"_(Copy)_", icon:"fa-copy", action:function(e){e.preventDefault();doAction(8,"_(Copy)_",dev);}});
    opts.push({text:"_(Move)_", icon:"fa-paste", action:function(e){e.preventDefault();doAction(9,"_(Move)_",dev);}});
  }
  context.attach('#device_'+id, opts);
}

function home(source, target) {
  var equal = '?';
  $.ajax({
    async: false,
    url: '/webGui/include/Control.php',
    type: 'POST',
    dataType: 'text',
    data: {mode:'home',source:encodeURIComponent(dfm_htmlspecialchars(source)),target:encodeURIComponent(dfm_htmlspecialchars(target))},
    success: function(e){equal = e;}
  });
  return equal;
}

function resize() {
  $('div.autoheight').height(Math.max(window.innerHeight-320,330));
}

function selectAll() {
  if (dfm.running) {
    context.attach('#check_0', [{text:"_(Job running)_", icon:"fa fa-ban"}]);
    return;
  }
  context.destroy('#check_0');
  if ($('#check_0').hasClass('fa-square-o')) {
    $('i[id^="check_"]:visible').removeClass('fa-square-o').addClass('fa-check-square-o');
    $('input.extra').prop('disabled',false);
<?if (!$isshare):?>
    $('input.rename').prop('disabled',false);
<?endif;?>
  } else {
    $('i[id^="check_"]:visible').removeClass('fa-check-square-o').addClass('fa-square-o');
    $('input.extra').prop('disabled',true);
<?if (!$isshare):?>
    $('input.rename').prop('disabled',true);
<?endif;?>
  }
}

function selectOne(id, check=true) {
  if (dfm.running && check) {
    context.attach('#'+id, [{text:"_(Job running)_", icon:"fa fa-ban"}]);
    return;
  }
  context.destroy('#'+id);
  if ($('#'+id).hasClass('fa-square-o')) {
    $('#'+id).removeClass('fa-square-o').addClass('fa-check-square-o');
  } else {
    $('#'+id).removeClass('fa-check-square-o').addClass('fa-square-o');
  }
  var checked = 0;
  if (check) {
    $('i[id^="check_"]').each(function(){if ($(this).prop('id')!='check_0' && $(this).hasClass('fa-check-square-o')) checked++;});
    $('input.extra').prop('disabled',checked == 0);
<?if (!$isshare):?>
    $('input.rename').prop('disabled',checked != 1);
<?endif;?>
  } else {
    $('i[id^="queue_"]').each(function(){if ($(this).hasClass('fa-check-square-o')) checked++;});
    $('.ui-dfm .ui-dialog-buttonset button:eq(1)').prop('disabled',checked == 0);
  }
}

function errorSource() {
  swal({title:"_(Invalid source)_",text:"_(Not allowed to mix disk and user shares)_",html:true,type:'error',confirmButtonText:"_(Ok)_"});
}

function errorTarget() {
  swal({title:"_(Invalid target)_",text:"_(Enter a valid target)_",html:true,type:'error',confirmButtonText:"_(Ok)_"},function(x){dfm.window.find('#dfm_target').prop('disabled',false);});
}

function data(id) {
  var data = id.attr('data').dfm_quote();
<?if ($isshare):?>
  return id.attr('type') == 'd' ? data+'/' : data;
<?else:?>
  return data;
<?endif;?>
}

function fileName(file) {
  return file.indexOf('/')>=0 ? file.split('/').pop() : file;
}

function fileExtension(file) {
  file = fileName(file);
  return file.indexOf('.')>=0 ? file.split('.').pop() : '';
}

function fileEdit(id) {
  const known = ["","cfg","conf",<?=dfm_array(file($editor,FILE_IGNORE_NEW_LINES|FILE_SKIP_EMPTY_LINES))?>];
  var source = $('#'+id.dfm_proxy()).attr('data').dfm_quote();
  var ext = fileExtension(source);
  if (ext == 'zip') {
    // download zip files
    downloadFile(source);
    return;
  }
  dfm.window = $("#dfm_dialogWindow");
  if (!known.includes(ext)) {
    // file viewer - supported file extensions: .pdf, .jpg, .png, .jpeg, .gif
    dfm.window.html($("#dfm_templateViewFile").html().replace('{$0}',source).dfm_build());
    return;
  }
  // file editor dialog
  dfm.window.html($("#dfm_templateEditFile").html().replace('{$0}',source).dfm_build());
  dfm.window.dialog({
    classes: {'ui-dialog': 'ui-dfm ui-corner-all'},
    autoOpen: true,
    title: fileName(source),
    width: 'auto',
    height: 'auto',
    resizable: false,
    modal: true,
    draggable: false,
    buttons: {
      "_(Save)_": function(){
        $.post('/webGui/include/Control.php',{mode:'save', file:encodeURIComponent(source), data:encodeURIComponent(editor.session.getValue())});
        dfm.window.dialog('close');
        dfm.window.dialog('destroy');
        setTimeout(loadList,100);
      },
      "_(Cancel)_": function(){
        dfm.window.dialog('close');
        dfm.window.dialog('destroy');
      }
    }
  });
  $('.ui-dfm .ui-dialog-titlebar-close').html('<i class="fa fa-expand"></i>').prop('title',"_(Expand)_").prop('onclick',null).off('click').click(function(){fullWindow();}).show();
}

function fullWindow() {
  // this class is used to determine if the dialog is sized via the default CSS in default-dynamix.css or by JS when the user clicks the "expand" button.
  $('.ui-dialog').toggleClass('ui-dialog-content-full');
  if ($('.ui-dfm .ui-dialog-titlebar-close').html().indexOf('expand')>=0) {
    dfm.window.dialog('option','height',window.innerHeight-40);
    dfm.window.dialog('option','width',window.innerWidth);
    dfm.window.dialog('option','position',{my:'top',at:'top',of:window});
    $('.ui-dfm .ui-dialog-titlebar-close').html("<i class='fa fa-compress'></i>").prop("title","_(Compress)_");
  } else {
    dfm.window.dialog('option','height',Math.min(window.innerHeight-80,800));
    dfm.window.dialog('option','width',Math.min(window.innerWidth,1200));
    dfm.window.dialog('option','position',{my:'center',at:'center',of:window});
    $('.ui-dfm .ui-dialog-titlebar-close').html("<i class='fa fa-expand'></i>").prop("title","_(Expand)_");
  }
  editor.resize();
}

function doJobs(title) {
  dfm.window = $("#dfm_dialogWindow");
  dfm.window.html($('#dfm_templateJobs').html().dfm_build());
  dfm.window.dialog({
    classes: {'ui-dialog': 'ui-dfm ui-corner-all'},
    autoOpen: true,
    title: title,
    height: 'auto',
    width: 'auto',
    resizable: false,
    draggable: false,
    modal: true,
    buttons: {
      "_(Start)_": function(){
        $.post('/webGui/include/Control.php', {mode:'start'}, function(queue){
          if (parseInt(queue) > 0) {
            if (dfm.window.find('i[id^="queue_"]').length < 2) $.removeCookie('dfm_control.jobs');
            dfm.window.dialog('close');
            dfm_openDialog();
            dfm_fileManager('start');
          }
        });
      },
      "_(Delete)_": function(){
        let row = [];
        dfm.window.find('i[id^="queue_"]').each(function(){if ($(this).hasClass('fa-check-square-o')) row.push($(this).prop('id').split('_')[1]);});
        $.post('/webGui/include/Control.php',{mode:'undo',row:row.join(',')},function(queue){
          $.post('/webGui/include/Control.php',{mode:'jobs'},function(jobs){
            $('#dfm_jobs').html(jobs);
            if (dfm.window.find('i[id^="queue_"]').length==0) $.removeCookie('dfm_control.jobs');
          });
          if (parseInt(queue) == 1) {
            setTimeout(function(){$('#dfm_jobs').html("<div id='dfm_joblist'><i class='fa fa-fw fa-minus-square-o grey-text job'></i>_(No jobs scheduled)_ ...</div>");},100);
            $('.ui-dfm .ui-dialog-buttonset button:eq(0)').prop('disabled',true);
            $('.dfm_control.jobs').prop('disabled',true);
            $.removeCookie('dfm_control.jobs');
          }
          $('.ui-dfm .ui-dialog-buttonset button:eq(1)').prop('disabled',true);
        });
      },
      "_(Done)_": function(){
        dfm.window.dialog('close');
        dfm.window.dialog('destroy');
      }
    }
  });
  $('.ui-dfm .ui-dialog-titlebar-close').css({'display':'none'});
  if (dfm.running) $('.ui-dfm .ui-dialog-buttonset button:eq(0)').prop('disabled',true);
  $('.ui-dfm .ui-dialog-buttonset button:eq(1)').prop('disabled',true);
}

var filemonitor = new NchanSubscriber('/sub/filemonitor',{subscriber:'websocket'});
filemonitor.on('message', function(state) {
  if (state == 1 && !dfm.running && !timers.filemonitor) timers.filemonitor = setTimeout(function(){if (dfm.running) clearTimeout(timers.filemonitor); else refresh();},1500);
});
setTimeout(function(){filemonitor.start();},3000);

// File tree navigation constants
var FOLDER_EXPAND_DELAY = 300;  // Delay per folder expansion in openFolderRecursive (ms)
var NAVIGATION_BUFFER = 500;    // Additional buffer time for navigation completion (ms)

function setupTargetNavigation() {
  var $target = dfm.window.find('#dfm_target');
  if (!$target.length) return;
  
  var navigationTimeout;
  var inputElement = $target[0];
  var isNavigatingFromPopular = false;
  var isProgrammaticNavigation = false;  // Flag for programmatic tree navigation
  var savedInputValue = '';  // Save input value during programmatic navigation
  var lastNavigatedPath = '';  // Track last navigated path for backward navigation
  
  // Event handlers for capture phase to prevent fileTree from closing
  var preventClose = function(e) {
    // Re-open tree if it was closed (must do this BEFORE stopImmediatePropagation)
    if (e.type === 'click') {
      var $tree = $target.closest('dd').find('.fileTree');
      if ($tree.length && !$tree.is(':visible')) {
        // Only show if tree has content
        var $content = $tree.find('.jqueryFileTree');
        if ($content.length && $content.children().length > 0) {
          try {
            $tree.show();
          } catch(err) {
            console.error('Error showing tree:', err);
          }
        }
      }
    }
    
    e.stopPropagation();
    e.stopImmediatePropagation();
  };
  
  // Attach to input element in capture phase (runs before jquery.filetree.js handler)
  if (inputElement) {
    inputElement.addEventListener('mousedown', preventClose, true);
    inputElement.addEventListener('focus', preventClose, true);
    inputElement.addEventListener('click', preventClose, true);
  }
  
  // Handle clicks on ANY tree item to remove popular destinations
  var treeClickHandler = function(e) {
    var $link = $(e.target).closest('.jqueryFileTree a');
    if ($link.length === 0) return;
    
    // Remove popular section when clicking on any tree item (except popular items themselves)
    if (!$link.closest('.popular-destination').length) {
      var $tree = $('.fileTree .jqueryFileTree');
      $tree.find('.popular-header, .popular-destination, .popular-separator').remove();
    }
  };
  
  // Attach tree click handler in capture phase
  document.addEventListener('click', treeClickHandler, true);
  
  // Handle clicks on popular destinations - use capture phase to run before jQueryFileTree handler
  var popularClickHandler = function(e) {
    var $link = $(e.target).closest('.popular-destination a');
    if ($link.length === 0) return;
    
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    
    // Get path from data-path attribute
    var path = $link.attr('data-path');
    if (!path) return;
    
    // Remove trailing slash for input field
    var cleanPath = path.replace(/\/+$/, '');
    
    // Remove popular section immediately (before any navigation)
    var $tree = $('.fileTree .jqueryFileTree');
    $tree.find('.popular-header, .popular-destination, .popular-separator').remove();
    
    // Set flag to prevent input handler from triggering
    isNavigatingFromPopular = true;
    
    // Set input field value (this triggers 'input' event)
    $target.val(cleanPath + '/');
    
    // Trigger navigation to expand the path in normal tree
    navigateFileTree(cleanPath + '/');
    lastNavigatedPath = cleanPath + '/';
    
    // Reset flag after a short delay
    setTimeout(function() {
      isNavigatingFromPopular = false;
    }, 100);
    
    return false;
  };
  
  // Attach in capture phase to run before jQueryFileTree handlers
  document.addEventListener('click', popularClickHandler, true);
  
  // Hide/show popular destinations based on input field content
  $target.on('input', function() {
    // Ignore input events triggered by popular click or programmatic navigation
    if (isNavigatingFromPopular || isProgrammaticNavigation) {
      return;
    }
    
    var inputValue = this.value.trim();
    var $tree = $('.fileTree .jqueryFileTree');
    
    if (inputValue) {
      // Input is not empty - remove popular destinations completely
      $tree.find('.popular-header, .popular-destination, .popular-separator').remove();
    } else {
      // Input is empty - popular destinations will be shown on next tree reload
    }
    
    clearTimeout(navigationTimeout);
    
    if (!inputValue) {
      // Reset tree to initial state when input is cleared
      resetFileTree($target);
      lastNavigatedPath = '';
      return;
    }
    if (inputValue[inputValue.length - 1] !== '/') return;
    
    // Check if we're navigating backward (path got shorter)
    if (lastNavigatedPath && inputValue.length < lastNavigatedPath.length && lastNavigatedPath.startsWith(inputValue)) {
      // Close all folders between the new path and the old path
      var pathToClose = lastNavigatedPath;
      while (pathToClose.length > inputValue.length) {
        closeFolderPath(pathToClose);
        // Remove the last segment to go up one level
        pathToClose = pathToClose.replace(/\/+$/, '');  // Remove trailing slashes
        var lastSlash = pathToClose.lastIndexOf('/');
        if (lastSlash === -1) break;
        pathToClose = pathToClose.substring(0, lastSlash + 1);
      }
      lastNavigatedPath = inputValue;
      return;
    }
    
    navigationTimeout = setTimeout(function() {
      navigateFileTree(inputValue);
      lastNavigatedPath = inputValue;
    }, 200);
  });
  
  // Restore input value if changed during programmatic navigation
  $target.on('change', function() {
    var isProgrammaticNav = $target.data('isProgrammaticNavigation');
    var savedValue = $target.data('savedInputValue');
    if (isProgrammaticNav && savedValue) {
      this.value = savedValue;
    }
  });
  
  // Cleanup on dialog close
  dfm.window.on('dialogclose', function() {
    document.removeEventListener('click', treeClickHandler, true);
    document.removeEventListener('click', popularClickHandler, true);
    if (inputElement) {
      inputElement.removeEventListener('mousedown', preventClose, true);
      inputElement.removeEventListener('focus', preventClose, true);
      inputElement.removeEventListener('click', preventClose, true);
    }
  });
}

function closeFolderPath(path) {
  var $tree = $('.jqueryFileTree').first();
  if ($tree.length === 0) return;
  
  // Remove trailing slash for searching
  var cleanPath = path.replace(/\/+$/, '');
  
  // Find the folder link by rel attribute
  var $folderLink = $tree.find('a[rel="' + cleanPath + '/"]');
  if ($folderLink.length === 0) return;
  
  var $folderLi = $folderLink.closest('li');
  
  // Close the folder: change class from expanded to collapsed
  $folderLi.removeClass('expanded').addClass('collapsed');
  
  // Remove all child elements (the nested <ul>)
  $folderLi.find('ul').remove();
}

function resetFileTree($target) {
  // Find the .fileTree container (not the jqueryFileTree inside it)
  var $treeContainer = $target.siblings('.fileTree');
  if ($treeContainer.length === 0) {
    return;
  }
  
  // Hide the tree first
  $treeContainer.hide();
  
  // Empty the container - this will cause fileTreeAttach to reload on next click
  $treeContainer.empty();
  
  // Show the tree again by simulating a click
  // fileTreeAttach checks if html() is empty and will reload
  setTimeout(function() {
    $target.click();
  }, 100);
}

function navigateFileTree(path) {
  var $tree = $('.jqueryFileTree').first();
  if ($tree.length === 0) {
    return;
  }
  
  var $target = dfm.window.find('#dfm_target');
  var pickroot = $target.attr('data-pickroot') || '/mnt';
  
  path = path.replace(/\/+$/, '');
  
  if (path.indexOf(pickroot) !== 0) {
    return;
  }
  
  var relativePath = path.substring(pickroot.length).replace(/^\/+/, '');
  var parts = relativePath.split('/').filter(function(p) { return p.length > 0; });
  
  // Use jQuery.data() to store values accessible from anywhere
  $target.data('savedInputValue', path + '/');
  $target.data('isProgrammaticNavigation', true);
  
  openFolderRecursive($tree, pickroot, parts, 0);
  
  // Reset flag after navigation completes
  setTimeout(function() {
    $target.data('isProgrammaticNavigation', false);
    $target.data('savedInputValue', '');
  }, parts.length * FOLDER_EXPAND_DELAY + NAVIGATION_BUFFER);
}

function openFolderRecursive($tree, pickroot, parts, index) {
  if (index >= parts.length) return;
  
  var pathSoFar = pickroot + '/' + parts.slice(0, index + 1).join('/');
  var $folderLink = $tree.find('a[rel="' + pathSoFar + '/"]');
  
  if ($folderLink.length === 0) return;
  
  var $folderLi = $folderLink.parent();
  
  if ($folderLi.hasClass('expanded')) {
    setTimeout(function() {
      openFolderRecursive($tree, pickroot, parts, index + 1);
    }, 100);
    return;
  }
  
  if ($folderLi.hasClass('collapsed') || $folderLi.hasClass('directory')) {
    $folderLink.trigger('click');
    setTimeout(function() {
      openFolderRecursive($tree, pickroot, parts, index + 1);
    }, FOLDER_EXPAND_DELAY);
  }
}

function doAction(action, title, id) {
  var link   = id.substr(0,1) == '/';
  var source = link ? id : data($('#'+id));
  var path   = source.substr(1).split('/');
  var zfs    = '';
<?if ($dfm['zfs']):?>
  if ([1,4].includes(action) && path[0] == 'mnt') {
    switch (path.length) {
    case 3:
      if (path[2] == '') zfs = path[1]+'/';
      break;
    case 4:
      if (path[3] == '') zfs = path[1]+'/'+path[2];
      break;
    }
  }
<?endif;?>
  var access = ['mnt','boot'];
  if (!access.includes(path[0])) return;
  var user   = /^(user0?|rootshare)$/.test(path[1]);
  var root   = '/'+path[0]+(user ? '/'+path[1] : '');
  var share  = user || !path[2] || (link && path.length==3) ? '' : path[2]+'/';
  var ud     = ['disks','remotes'].includes(path[1]); // unassigned devices
  var match  = ud || user ? '' : '^(?!\\/mnt\\/(user0?|rootshare)\\/).*$';
  var name   = path.pop() || path.pop();
  var hdlink = "<?=$var['fuse_directio'] == 1 ? '1' : ''?>";
  dfm.window = $("#dfm_dialogWindow");
  switch (action) {
  case 0: // create folder
    dfm.window.html($('#dfm_templateCreateFolder').html());
    source = dir;
    break;
  case 1: // delete folder
    dfm.window.html($('#dfm_templateDeleteFolder').html());
    dfm_createSource(source.dfm_strip());
    break;
  case 2: // rename folder
    dfm.window.html($('#dfm_templateRenameFolder').html());
    dfm_createSource(name);
    dfm.window.find('#dfm_target').val(name);
    break;
  case 3: // copy folder
    dfm.window.html($('#dfm_templateCopyFolder').html());
    dfm_createSource(source.dfm_strip());
    dfm.window.find('#dfm_target').attr('data-pickroot',root).attr('data-picktop',root).attr('data-pickmatch',match).attr('data-show-popular','true').fileTreeAttach(null,null,function(path){
      var bits = path.substr(1).split('/');
      var auto = bits.length>3 ? '' : share;
      dfm.window.find('#dfm_target').val(path+auto).change();
    });
    dfm.window.find('#dfm_target').css('margin-bottom', '320px');
    break;
  case 4: // move folder
    dfm.window.html($('#dfm_templateMoveFolder').html());
    dfm_createSource(source.dfm_strip());
    dfm.window.find('#dfm_target').attr('data-pickroot',root).attr('data-picktop',root).attr('data-pickmatch',match).attr('data-pickfilter','SHOW_POPULAR').fileTreeAttach(null,null,function(path){
      var bits = path.substr(1).split('/');
      var auto = bits.length>3 ? '' : share;
      dfm.window.find('#dfm_target').val(path+auto).change();
    });
    dfm.window.find('#dfm_target').css('margin-bottom', '320px');
    break;
  case 6: // delete file
    dfm.window.html($('#dfm_templateDeleteFile').html());
    dfm_createSource(source);
    break;
  case 7: // rename file
    dfm.window.html($('#dfm_templateRenameFile').html());
    dfm_createSource(name);
    dfm.window.find('#dfm_target').val(name);
    break;
  case 8: // copy file
    dfm.window.html($('#dfm_templateCopyFile').html());
    dfm_createSource(source);
    dfm.window.find('#dfm_target').attr('data-pickroot',root).attr('data-picktop',root).attr('data-pickmatch',match).attr('data-pickfilter','SHOW_POPULAR').fileTreeAttach(null,null,function(path){
      dfm.window.find('#dfm_target').val(path).change();
    });
    dfm.window.find('#dfm_target').css('margin-bottom', '320px');
    break;
  case 9: // move file
    dfm.window.html($('#dfm_templateMoveFile').html());
    dfm_createSource(source);
    dfm.window.find('#dfm_target').attr('data-pickroot',root).attr('data-picktop',root).attr('data-pickmatch',match).attr('data-pickfilter','SHOW_POPULAR').fileTreeAttach(null,null,function(path){
      dfm.window.find('#dfm_target').val(path).change();
    });
    dfm.window.find('#dfm_target').css('margin-bottom', '320px');
    break;
  case 11: // change owner
    dfm.window.html($('#dfm_templateChangeOwner').html());
    var owner = $('#'+id.dfm_bring('owner')).text();
    dfm_createSource(source.dfm_strip());
    dfm.window.find('#dfm_target').val(owner);
    break;
  case 12: // change permission
    dfm.window.html($('#dfm_templateChangePermission').html());
    var perm = $('#'+id.dfm_bring('perm')).text();
    dfm_createSource(source.dfm_strip());
    dfm.window.find('#dfm_owner').val('u-'+perm.substr(1,2).dfm_patch());
    dfm.window.find('#dfm_group').val('g-'+perm.substr(4,2).dfm_patch());
    dfm.window.find('#dfm_other').val('o-'+perm.substr(7,2).dfm_patch());
    break;
  case 13: // download file
    downloadFile(source,name);
    return;
  case 14: // calculate occupied space
    timers.calc = setTimeout(function(){$('div.spinner.fixed').show('slow');},500);
    $.post('/webGui/include/Control.php',{mode:'calc',source:encodeURIComponent(dfm_htmlspecialchars(source))},function(text){
      clearTimeout(timers.calc);
      $('div.spinner.fixed').hide('slow');
      swal({title:"_(Calculate Occupied Space)_",text:text,html:true,confirmButtonText:"_(Ok)_"});
    }).fail(function(xhr){
      clearTimeout(timers.calc);
      $('div.spinner.fixed').hide('slow');
      swal({title:"Error", text:"Calculate failed: "+xhr.status+" "+xhr.statusText, type:"error"});
    });
    return;
  case 15: // search
    dfm.window.html($('#dfm_templateSearch').html());
    dfm_createSource(source.dfm_strip());
    dfm.window.find('.dfm_loc').html('&nbsp;').css({'line-height':'normal'});
    dfm.window.find('.dfm_text').html('').css({'line-height':'normal'});
    break;
  }
  dfm.window.dialog({
    classes: {'ui-dialog': 'ui-dfm ui-corner-all'},
    autoOpen: true,
    title: title,
    width: 'auto',
    resizable: false,
    draggable: false,
    modal: true,
    close: function() {
      $('.ui-dfm').off('mousedown.dfmFileTree');
    },
    open: function() {
      // Add warning to buttonpane for all relevant actions
      var warningTexts = {
        0: "<?=_("This creates a folder at the current level")?>",
        1: "<?=_("This deletes the folder and all its content")?>",
        2: "<?=_("This renames the folder to the new name")?>",
        3: "<?=_("This copies the folder and all its content to another folder")?>",
        4: "<?=_("This moves the folder and all its content to another folder")?>",
        6: "<?=_("This deletes the selected file")?>",
        7: "<?=_("This renames the selected file")?>",
        8: "<?=_("This copies the selected file")?>",
        9: "<?=_("This moves the selected file")?>",
        11: "<?=_("This changes the owner of the source recursively")?>",
        12: "<?=_("This changes the permission of the source recursively")?>"
      };
      var warningText = warningTexts[action];
      if (warningText) {
        var $warning = $('<div class="dfm-warning">').html('<i class="fa fa-warning dfm"></i> ' + warningText);
        $('.ui-dfm .ui-dialog-buttonset').prepend($warning);
      }
    },
    buttons: {
      "_(Start)_": function(){
        if (dfm.running) return;
        var target = dfm.window.find('#dfm_target');
        if (target.length) {
          target = target.val();
          switch (action) {
          case 0: // create folder
          case 2: // rename folder
          case 7: // rename file
            var valid = /^[^\/]*$/; // no slashes allowed
            break;
          case 4: // move folder
          case 9: // move file
            // disallow mixing of disk and user shares
            var valid = ud ? /^\/mnt\/.+/ : (user ? /^\/mnt\/(user0?|disks|remotes)\/.+/ : /^\/mnt\/(?!.*(user0?|rootshare)\/).+$|^\/boot\/.+/);
            break;
          case 11: // change owner
            var valid = /.+/;
            target += (target == 'root' ? ':root' : ':users');
            break;
          case 12: // change permission
            var valid = /.+/;
            target = [];
            target.push(dfm.window.find('#dfm_owner').val());
            target.push(dfm.window.find('#dfm_group').val());
            target.push(dfm.window.find('#dfm_other').val());
            target = target.join(',')+',ugo+X';
            break;
          case 15: // search
            var valid = /.+/;
            bulk = false;
            dfm.window.find('#dfm_target').prop('disabled',true);
            dfm.window.find('.dfm_loc').html('&nbsp;');
            dfm.window.find('#dfm_files').html('');
            break;
          default:
            // disallow mixing of disk and user shares
            var valid = ud ? /^\/mnt\/.+/ : (user ? /^\/mnt\/(user0?|disks|remotes)\/.+/ : /^\/mnt\/(?!.*(user0?|rootshare)\/).+$|^\/boot\/.+/);
            break;
          }
          if (!target || !valid.test(target)) {errorTarget(); return;}
        } else target = '';
        dfm.window.find('.dfm_text').removeClass('orange-text').html("_(Running)_...");
        dfm.window.find('#dfm_target').prop('disabled',true);
        dfm.window.find('#dfm_sparse').prop('disabled',true);
        dfm.window.find('#dfm_exist').prop('disabled',true);
        dfm.window.find('.dfm_sparse').css({'opacity':'0.5'});
        dfm.window.find('.dfm_exist').css({'opacity':'0.5'});
        if (action == 11) {
          dfm.window.find('#dfm_owner').prop('disabled',true);
          dfm.window.find('#dfm_group').prop('disabled',true);
          dfm.window.find('#dfm_other').prop('disabled',true);
        }
        dfm_footer('hide');
        dfm_fileManager('start');
        $.post('/webGui/include/Control.php',{mode:'file',action:action,title:encodeURIComponent(title),source:encodeURIComponent(source),target:encodeURIComponent(target),hdlink:hdlink,sparse:dfm.window.find('#dfm_sparse').val(),exist:dfm.window.find('#dfm_exist').val(),zfs:encodeURIComponent(zfs)},function(){
          $.post('/webGui/include/Control.php',{mode:'read'},function(data){
            dfm_read = JSON.parse(data);
            dfm_read.action = parseInt(dfm_read.action);
          });
        });
      },
      "_(Queue)_": function(){
        var target = dfm.window.find('#dfm_target');
        if (target.length) {
          target = target.val();
          switch (action) {
          case 0: // create folder
          case 2: // rename folder
          case 7: // rename file
            var valid = /^[^\/]*$/; // no slashes allowed
            break;
          case 4: // move folder
          case 9: // move file
            // disallow mixing of disk and user shares
            var valid = ud ? /^\/mnt\/.+/ : (user ? /^\/mnt\/(user0?|disks|remotes)\/.+/ : /^\/mnt\/(?!.*(user0?|rootshare)\/).+$|^\/boot\/.+/);
            break;
          case 11: // change owner
            var valid = /.+/;
            target += (target == 'root' ? ':root' : ':users');
            break;
          case 12: // change permission
            var valid = /.+/;
            target = [];
            target.push(dfm.window.find('#dfm_owner').val());
            target.push(dfm.window.find('#dfm_group').val());
            target.push(dfm.window.find('#dfm_other').val());
            target = target.join(',')+',ugo+X';
            break;
          default:
            // disallow mixing of disk and user shares
            var valid = ud ? /^\/mnt\/.+/ : (user ? /^\/mnt\/(user0?|disks|remotes)\/.+/ : /^\/mnt\/(?!.*(user0?|rootshare)\/).+$|^\/boot\/.+/);
            break;
          }
          if (!target || !valid.test(target)) {errorTarget(); return;}
        } else target = '';
        $.post('/webGui/include/Control.php',{mode:'file',task:encodeURIComponent(title.toLowerCase()),action:action,title:encodeURIComponent(title),source:encodeURIComponent(source),target:encodeURIComponent(target),hdlink:hdlink,sparse:dfm.window.find('#dfm_sparse').val(),exist:dfm.window.find('#dfm_exist').val(),zfs:encodeURIComponent(zfs)});
        dfm.window.dialog('close');
        dfm.window.dialog('destroy');
        $('.dfm_control.jobs').prop('disabled',false);
        $.cookie('dfm_control.jobs','1');
      },
      "_(Cancel)_": function(){
        if (dfm.running) $.post('/webGui/include/Control.php',{mode:'file',action:99},function(){setTimeout(loadList,500);});
        dfm_fileManager('stop');
        dfm.window.dialog('close');
        dfm.window.dialog('destroy');
      }
    }
  });
  dfm_close_button();
  preventFileTreeClose();
  
  // Setup file tree navigation for target input in copy/move dialogs (action 3=copy folder, 4=move folder, 8=copy file, 9=move file)
  if ([3,4,8,9].includes(action) && dfm.window.find('#dfm_target').length) {
    setupTargetNavigation();
  }
  
  if (action == 15) $('.ui-dfm .ui-dialog-buttonset button:eq(1)').prop('disabled',true);
  setTimeout(function(){if (dfm.window.find('#dfm_target').length) dfm.window.find('#dfm_target').focus().click(); else $('.ui-dfm .ui-dialog-buttonset button:eq(0)').focus();});
}

function doActions(action, title) {
  var source = [], type = [], owner = [], perm = [], zfs = [];
  if (action > 0) {
    $('i[id^="check_"]').each(function(){
      if ($(this).prop('id')!='check_0' && $(this).hasClass('fa-check-square-o')) {
        var id = $(this).prop('id');
        source.push(data($('#'+id.dfm_fetch('row'))));
        type.push($('#'+id.dfm_fetch('row')).attr('type'));
        owner.push($('#'+id.dfm_fetch('owner')).text());
        perm.push($('#'+id.dfm_fetch('perm')).text());
      }
    });
  }
  if (action > 0 && action < 15) {
    var bulk   = source.length > 1;
    var path   = source[0].substr(1).split('/');
    var access = ['mnt','boot'];
    if (!access.includes(path[0])) return;
    var user   = /^(user0?|rootshare)$/.test(path[1]);
    var root   = '/'+path[0]+(user ? '/'+path[1] : '');
    var share  = user || !path[2] ? '' : path[2]+'/';
    var ud     = ['disks','remotes'].includes(path[1]); // unassigned devices
    var match  = ud || user ? '' : '^(?!\\/mnt\\/(user0?|rootshare)\\/).*$';
    var name   = path.pop() || path.pop();
    var hdlink = "<?=$var['fuse_directio'] == 1 ? '1' : ''?>";
    var u      = false;
    var d      = false;
    if (bulk) {
      for (var i=0,s; s=source[i]; i++) {
        s = s.dfm_strip();
        source[i] = s;
        var p = s.substr(1).split('/');
        if (/^user0?$/.test(p[1])) u = true; else d = true;
<?if ($dfm['zfs']):?>
        if ([1,4].includes(action) && p[0] == 'mnt' && type[i] == 'd') {
          switch (p.length) {
          case 2:
            zfs.push(p[1]+'/');
            break;
          case 3:
            zfs.push(p[1]+'/'+p[2]);
            break;
          }
        }
      }
    } else {
      var p = source[0].substr(1).dfm_strip().split('/');
      if ([1,4].includes(action) && p[0] == 'mnt' && type[0] == 'd') {
        switch (p.length) {
        case 2:
          zfs.push(p[1]+'/');
          break;
        case 3:
          zfs.push(p[1]+'/'+p[2]);
          break;
        }
<?endif;?>
      }
    }
    if (u && d) {errorSource(); return;} // disallow mixing of disk and user shares
  }
  dfm.window = $("#dfm_dialogWindow");
  switch (action) {
  case 0: // create folder
    dfm.window.html($('#dfm_templateCreateFolder').html());
    source[0] = dir;
    break;
  case 1: // delete object
    dfm.window.html($('#dfm_templateDeleteObject').html());
    dfm_createSource(source);
    break;
  case 2: // rename object
    dfm.window.html($('#dfm_templateRenameObject').html());
    dfm_createSource(name);
    dfm.window.find('#dfm_target').val(name);
    break;
  case 3: // copy object
    dfm.window.html($('#dfm_templateCopyObject').html());
    dfm_createSource(source);
    dfm.window.find('#dfm_target').attr('data-pickroot',root).attr('data-picktop',root).attr('data-pickmatch',match);
    if (bulk || type[0] == 'd') dfm.window.find('#dfm_target').attr('data-pickfilter','SHOW_POPULAR,HIDE_FILES_FILTER');
    else dfm.window.find('#dfm_target').attr('data-pickfilter','SHOW_POPULAR');
    dfm.window.find('#dfm_target').fileTreeAttach(null,null,function(path){
      var bits = path.substr(1).split('/');
      var auto = bulk || bits.length>3 ? '' : (type[0] == 'd' ? share : '');
      dfm.window.find('#dfm_target').val(path+auto).change();
    });
    dfm.window.find('#dfm_target').css('margin-bottom', '320px');
    break;
  case 4: // move object
    dfm.window.html($('#dfm_templateMoveObject').html());
    dfm_createSource(source);
    dfm.window.find('#dfm_target').attr('data-pickroot',root).attr('data-picktop',root).attr('data-pickmatch',match);
    if (bulk || type[0] == 'd') dfm.window.find('#dfm_target').attr('data-pickfilter','SHOW_POPULAR,HIDE_FILES_FILTER');
    else dfm.window.find('#dfm_target').attr('data-pickfilter','SHOW_POPULAR');
    dfm.window.find('#dfm_target').fileTreeAttach(null,null,function(path){
      var bits = path.substr(1).split('/');
      var auto = bulk || bits.length > 3 ? '' : (type[0] == 'd' ? share : '');
      dfm.window.find('#dfm_target').val(path+auto).change();
    });
    dfm.window.find('#dfm_target').css('margin-bottom', '320px');
    break;
  case 11: // change owner
    dfm.window.html($('#dfm_templateChangeOwner').html());
    dfm_createSource(source);
    if (!bulk) dfm.window.find('#dfm_target').val(owner[0]);
    break;
  case 12: // change permission
    dfm.window.html($('#dfm_templateChangePermission').html());
    dfm_createSource(source);
    if (!bulk) {
      dfm.window.find('#dfm_owner').val('u-'+perm[0].substr(1,2).dfm_patch());
      dfm.window.find('#dfm_group').val('g-'+perm[0].substr(4,2).dfm_patch());
      dfm.window.find('#dfm_other').val('o-'+perm[0].substr(7,2).dfm_patch());
    }
    break;
  case 14: // calculate occupied space
    timers.calc = setTimeout(function(){$('div.spinner.fixed').show('slow');},500);
    $.post('/webGui/include/Control.php',{mode:'calc',source:encodeURIComponent(dfm_htmlspecialchars(source.join('\n')))},function(text){
      clearTimeout(timers.calc);
      $('div.spinner.fixed').hide('slow');
      swal({title:"_(Calculate Occupied Space)_",text:text,html:true,confirmButtonText:"_(Ok)_"});
    }).fail(function(xhr){
      clearTimeout(timers.calc);
      $('div.spinner.fixed').hide('slow');
      swal({title:"Error", text:"Calculate failed: "+xhr.status+" "+xhr.statusText, type:"error"});
    });
    return;
  case 15: // search
    dfm.window.html($('#dfm_templateSearch').html());
    // folders only
    for (var i=0,t; t=type[i]; i++) if (t != 'd') source[i] = '';
    source = source.filter(n=>n);
    if (source.length == 0) source[0] = dir;
    dfm_createSource(source);
    dfm.window.find('.dfm_loc').html('&nbsp;').css({'line-height':'normal'});
    dfm.window.find('.dfm_text').html('').css({'line-height':'normal'});
    break;
  }
  dfm.window.find('#dfm_source').attr('size',Math.min(dfm.tsize[action],source.length));
  dfm.window.dialog({
    classes: {'ui-dialog': 'ui-dfm ui-corner-all'},
    autoOpen: true,
    title: title,
    width: 'auto',
    resizable: false,
    draggable: false,
    modal: true,
    close: function() {
      $('.ui-dfm').off('mousedown.dfmFileTree');
    },
    open: function() {
      // Add warning to buttonpane for all relevant actions (bulk operations)
      var warningTexts = {
        0: "<?=_("This creates a folder at the current level")?>",
        1: "<?=_("This deletes all selected sources")?>",
        2: "<?=_("This renames the selected source")?>",
        3: "<?=_("This copies all the selected sources")?>",
        4: "<?=_("This moves all the selected sources")?>",
        11: "<?=_("This changes the owner of the source recursively")?>",
        12: "<?=_("This changes the permission of the source recursively")?>"
      };
      var warningText = warningTexts[action];
      if (warningText) {
        var $warning = $('<div class="dfm-warning">').html('<i class="fa fa-warning dfm"></i> ' + warningText);
        $('.ui-dfm .ui-dialog-buttonset').prepend($warning);
      }
    },
    buttons: {
      "_(Start)_": function(){
        if (dfm.running) return;
        var target = dfm.window.find('#dfm_target');
        if (target.length) {
          target = target.val();
          switch (action) {
          case 0: // create folder
            bulk = false;
          case 2: // rename object
            var valid = /^[^\/]*$/; // no slashes allowed
            break;
          case 4: // move object
            // disallow mixing of disk and user shares
            var valid = ud ? /^\/mnt\/.+/ : (user ? /^\/mnt\/(user0?|disks|remotes)\/.+/ : /^\/mnt\/(?!.*(user0?|rootshare)\/).+$|^\/boot\/.+/);
            break;
          case 11: // change owner
            var valid = /.+/;
            target += (target == 'root' ? ':root' : ':users');
            bulk = false;
            break;
          case 12: // change permission
            var valid = /.+/;
            target = [];
            target.push(dfm.window.find('#dfm_owner').val());
            target.push(dfm.window.find('#dfm_group').val());
            target.push(dfm.window.find('#dfm_other').val());
            target = target.join(',')+',ugo+X';
            bulk = false;
            break;
          case 15: // search
            var valid = /.+/;
            bulk = false;
            dfm.window.find('#dfm_target').prop('disabled',true);
            dfm.window.find('.dfm_loc').html('&nbsp;');
            dfm.window.find('#dfm_files').html('');
            break;
          default:
            // disallow mixing of disk and user shares
            var valid = ud ? /^\/mnt\/.+/ : (user ? /^\/mnt\/(user0?|disks|remotes)\/.+/ : /^\/mnt\/(?!.*(user0?|rootshare)\/).+$|^\/boot\/.+/);
            break;
          }
          if (!target || !valid.test(target)) {errorTarget(); return;}
        } else target = '';
        if (bulk && target.length>0 && target.substr(-1)!='/') target += '/';
        dfm.window.find('#dfm_target').prop('disabled',true);
        dfm.window.find('#dfm_sparse').prop('disabled',true);
        dfm.window.find('#dfm_exist').prop('disabled',true);
        dfm.window.find('.dfm_sparse').css({'opacity':'0.5'});
        dfm.window.find('.dfm_exist').css({'opacity':'0.5'});
        if (action == 12) {
          dfm.window.find('#dfm_owner').prop('disabled',true);
          dfm.window.find('#dfm_group').prop('disabled',true);
          dfm.window.find('#dfm_other').prop('disabled',true);
        }
        dfm.window.find('.dfm_text').removeClass('orange-text').html("_(Running)_...");
        dfm_footer('hide');
        dfm_fileManager('start');
        $.post('/webGui/include/Control.php',{mode:'file',action:action,title:encodeURIComponent(title),source:encodeURIComponent(source.join('\r')),target:encodeURIComponent(target),hdlink:hdlink,sparse:dfm.window.find('#dfm_sparse').val(),exist:dfm.window.find('#dfm_exist').val(),zfs:encodeURIComponent(zfs.join('\r'))},function(){
          $.post('/webGui/include/Control.php',{mode:'read'},function(data){
            dfm_read = JSON.parse(data);
            dfm_read.action = parseInt(dfm_read.action);
          });
        });
      },
      "_(Queue)_": function(){
        var target = dfm.window.find('#dfm_target');
        if (target.length) {
          target = target.val();
          switch (action) {
          case 0: // create folder
            bulk = false;
          case 2: // rename object
            var valid = /^[^\/]*$/; // no slashes allowed
            break;
          case 4: // move object
            // disallow mixing of disk and user shares
            var valid = ud ? /^\/mnt\/.+/ : (user ? /^\/mnt\/(user0?|disks|remotes)\/.+/ : /^\/mnt\/(?!.*(user0?|rootshare)\/).+$|^\/boot\/.+/);
            break;
          case 11: // change owner
            var valid = /.+/;
            target += (target == 'root' ? ':root' : ':users');
            bulk = false;
            break;
          case 12: // change permission
            var valid = /.+/;
            target = [];
            target.push(dfm.window.find('#dfm_owner').val());
            target.push(dfm.window.find('#dfm_group').val());
            target.push(dfm.window.find('#dfm_other').val());
            target = target.join(',')+',ugo+X';
            bulk = false;
            break;
          default:
            // disallow mixing of disk and user shares
            var valid = ud ? /^\/mnt\/.+/ : (user ? /^\/mnt\/(user0?|disks|remotes)\/.+/ : /^\/mnt\/(?!.*(user0?|rootshare)\/).+$|^\/boot\/.+/);
            break;
          }
          if (!target || !valid.test(target)) {errorTarget(); return;}
        } else target = '';
        $.post('/webGui/include/Control.php',{mode:'file',task:encodeURIComponent(title.toLowerCase()),action:action,title:encodeURIComponent(title),source:encodeURIComponent(source.join('\r')),target:encodeURIComponent(target),hdlink:hdlink,sparse:dfm.window.find('#dfm_sparse').val(),exist:dfm.window.find('#dfm_exist').val(),zfs:encodeURIComponent(zfs.join('\r'))});
        dfm.window.dialog('close');
        dfm.window.dialog('destroy');
        $('.dfm_control.jobs').prop('disabled',false);
        $.cookie('dfm_control.jobs','1');
      },
      "_(Cancel)_": function(){
        if (dfm.running) $.post('/webGui/include/Control.php',{mode:'file',action:99},function(){setTimeout(loadList,500);});
        dfm_fileManager('stop');
        dfm.window.dialog('close');
        dfm.window.dialog('destroy');
      }
    }
  });
  dfm_close_button();
  preventFileTreeClose();
  
  // Setup file tree navigation for target input in copy/move dialogs (action 3=copy, 4=move)
  if ([3,4].includes(action) && dfm.window.find('#dfm_target').length) {
    setupTargetNavigation();
  }
  
  if (action == 15) $('.ui-dfm .ui-dialog-buttonset button:eq(1)').prop('disabled',true);
  setTimeout(function(){if (dfm.window.find('#dfm_target').length) dfm.window.find('#dfm_target').focus().click(); else $('.ui-dfm .ui-dialog-buttonset button:eq(0)').focus();});
}

function stopUpload(file,error,errorType) {
  window.onbeforeunload = null;
  currentXhr = null;
  $.post('/webGui/include/Control.php',{mode:'stop',file:encodeURIComponent(dfm_htmlspecialchars(file))});
  $('#dfm_uploadButton').val("_(Upload)_").prop('onclick',null).off('click').click(function(){$('#dfm_upload').click();});
  $('#dfm_uploadStatus').html('');
  $('#dfm_upload').val('');
  dfm.running = false;
  loadList();
  if (error) {
    var message = "_(File is removed)_";
    if (errorType === 'timeout') message += "<br><br>_(Upload timed out. Please check your network connection and try again.)_";
    else if (errorType === 'network') message += "<br><br>_(Network error occurred. Please check your connection and try again.)_";
    else if (errorType && errorType.indexOf('http') === 0) message += "<br><br>_(HTTP error: )_" + errorType.substring(5);
    setTimeout(function(){swal({title:"_(Upload Error)_",text:message,html:true,confirmButtonText:"_(Ok)_"});},200);
  }
}

function downloadFile(source) {
  var a = document.createElement('a');
  a.setAttribute('href',source);
  a.setAttribute('download',source.split('/').pop());
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function uploadFile(files,index,start,time) {
  var file = files[index];
  var slice = 20971520; // 20MB chunks - no Base64 overhead, raw binary
  var next = start + slice;
  var blob = file.slice(start, next);
  
  var xhr = new XMLHttpRequest();
  currentXhr = xhr; // Store for abort capability
  var filePath = dir.replace(/\/+$/, '') + '/' + dfm_htmlspecialchars(file.name);
  var url = '/webGui/include/Control.php?mode=upload&file=' + encodeURIComponent(filePath) + '&start=' + start + '&cancel=' + cancel;
  xhr.open('POST', url, true);
  xhr.setRequestHeader('Content-Type', 'application/octet-stream');
  xhr.setRequestHeader('X-CSRF-Token', '<?=$var['csrf_token']?>');
  xhr.timeout = Math.max(600000, slice / 1024 * 60); // ~1 minute per MB, minimum 10 minutes
  
  xhr.onload = function() {
    if (xhr.status < 200 || xhr.status >= 300) {
      stopUpload(file.name, true, 'http:' + xhr.status);
      return;
    }
    var reply = xhr.responseText;
    if (reply == 'stop') {stopUpload(file.name); return;}
    if (reply.indexOf('error') === 0) {
      console.error('Upload error:', reply);
      stopUpload(file.name,true); 
      return;
    }
    if (next < file.size) {
      var total = 0;
      var completed = 0;
      for (var i=0,f; f=files[i]; i++) {
        if (i < index) completed += f.size;
        total += f.size;
      }
      const d = new Date();
      var bytesTransferred = completed + next;
      var elapsedSeconds = (d.getTime() - time) / 1000;
      var speed = autoscale(bytesTransferred / elapsedSeconds);
      var percent = Math.floor(bytesTransferred / total * 100);
      $('#dfm_uploadStatus').html("_(Uploading)_: <span class='dfm_percent'>"+percent+"%</span><span class='dfm_speed'>Speed: "+speed+"</span><span class='orange-text'> ["+(index+1)+'/'+files.length+']&nbsp;&nbsp;'+file.name+"</span>");
      uploadFile(files,index,next,time);
    } else if (index < files.length-1) {
      // Clean up temp file for completed upload before starting next file
      $.post('/webGui/include/Control.php',{mode:'stop',file:encodeURIComponent(dfm_htmlspecialchars(file.name))});
      uploadFile(files,index+1,0,time);
    } else {stopUpload(file.name); return;}
  };
  
  xhr.onabort = function() {
    // User cancelled upload - trigger deletion via cancel=1 parameter
    $.post('/webGui/include/Control.php', {
      mode: 'upload',
      file: filePath,
      start: 0,
      cancel: 1
    }).always(function() {
      // Cleanup UI regardless of POST success/failure
      stopUpload(file.name, false);
    });
  };
  
  xhr.onerror = function() {
    // Don't show error if it was a user cancel
    if (cancel === 1) return;
    stopUpload(file.name, true, 'network');
  };
  
  xhr.ontimeout = function() {
    stopUpload(file.name, true, 'timeout');
  };
  
  xhr.send(blob);
}

var cancel = 0;
var currentXhr = null;

function startUpload(files) {
  if (files.length == 0) return;
  cancel = 0; // Reset cancel flag
  window.onbeforeunload = function(e){return '';};
  $('#dfm_uploadButton').val("_(Cancel)_").prop('onclick',null).off('click').click(function(){
    cancel=1;
    if (currentXhr) currentXhr.abort();
  });
  dfm.running = true;
  const d = new Date();
  uploadFile(files,0,0,d.getTime());
}

function filter(ext) {
  $('td.ext').each(function(){
    if ($(this).attr('data').search(ext) == -1) $(this).parent().hide(); else $(this).parent().show();
  });
}

function toggleTime(init) {
  $('.my_time').toggle();
  $('.my_age').toggle();
  if (init) return;
  $.cookie('my_time') == null ? $.cookie('my_time','age') : $.removeCookie('my_time');
}

function loadList() {
  var col = $.cookie('col')||2;
  var ord = $.cookie('dir')||0;
  $('#check_0').removeClass('fa-check-square-o').addClass('fa-square-o');
  timers.browse = setTimeout(function(){$('div.spinner.fixed').show();},500);
  $.get('/webGui/include/Browse.php',{dir:encodeURIComponent(dir),path:"<?=$path?>"},function(data){
    clearTimeout(timers.browse);
    $('div.spinner.fixed').hide();
    table.find('tbody,tfoot').remove();
    thead.after(data);
    table.tablesorter({headers:{0:{sorter:false},8:{sorter:false}},sortList:[[col,ord],[2,0]],sortAppend:[[2,0]],textAttribute:'data'});
    table.trigger('update',[true]);
    if ($.cookie('my_time')!=null) toggleTime(true);
    $('div#buttons').show();
  });
}

function xlink(link) {
  var path = decodeURIComponent(link).trim();
  
  // Always show dialog with selectable textarea (better mobile support)
  var inputId = 'dfm_path_input_' + Date.now();
  var inputHtml = '<textarea id="' + inputId + '" class="text-center font-mono" readonly style="resize:none; overflow:hidden; height:auto; min-height:2.6rem; line-height:1.3rem; padding:.5rem; width:100%; box-sizing:border-box; border:1px solid var(--inverse-border-color); border-radius:3px; background-color:var(--background-color);">' + path + '</textarea>';
  
  swal({
    title: '',
    text: inputHtml,
    html: true,
    showCancelButton: true,
    confirmButtonText: "_(Ok)_",
    cancelButtonText: "_(Terminal)_"
  }, function(isConfirm) {
    if (isConfirm === false) {
      // Terminal button was clicked (cancel button)
      var d = new Date();
      openTerminal('ttyd', 'File_Manager_' + d.getTime(), path);
    }
    // Ok button (isConfirm === true) or dialog dismissed - just close
  });
  
  // Enable input visibility and hide SweetAlert's own fieldset
  $('.sweet-alert').addClass('show-input');
  $('.sweet-alert fieldset').hide();
  
  // Auto-select text and handle clipboard on click
  setTimeout(function() {
    var input = document.getElementById(inputId);
    if (input) {
      input.select();
      input.focus();
      
      // Copy to clipboard when user clicks/taps
      $(input).on('click', function() {
        this.select();
        
        // Try to copy to clipboard
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(path).then(function() {
            // Show success tooltip
            var tooltip = $('<span class="clipboard-tooltip"><i class="fa fa-check green-text"></i> _(Copied to clipboard)_</span>');
            $('.sweet-alert').append(tooltip);
            
            setTimeout(function() {
              tooltip.fadeOut(300, function() { 
                $(this).remove(); 
              });
            }, 1000);
          }).catch(function() {
            // Silent fail - user can still manually copy
          });
        }
      });
    }
  }, 100);
}

$(function(){
  var dirs = dir.split('/'), url = [];
  if (dirs.length > 1) {
    for (var n=1; n < dirs.length; n++) {
      var subdir = dirs.slice(1,n+1);
      url.push('<a class="none" href="/<?=$path?>?dir=/'+encodeURIComponent(subdir.join('/'))+'" oncontextmenu="xlink(\'/' + encodeURIComponent(subdir.join('/')) + '\');return false">'+(n == 1 ? '<i class="fa fa-home"></i>' : dirs[n])+'</a>');
    }
  } else {
    url.push('<i class="fa fa-home red-text"></i>');
  }
  $('.title .left').html(url.join('<i class="fa fa-chevron-right"></i>'));
  $('.title .right').append('<span class="dfm_filter"><input type="text" id="dfm_filter" class="dfm_filter" oninput="filter(this.value)" autocomplete="off" spellcheck="false" placeholder="_(file type)_"><i class="fa fa-filter dfm_filter"></i></span><i class="fa fa-toggle-off" onclick="toggleTime()" style="cursor:pointer;" title="_(Toggle Time/Age display)_"></i>');
  table = $('table.indexer');
  thead = table.find('thead');
  table.bind('sortEnd',function(e,t){
    var sort = e.target.config.sortList.toString().split(',');
    $.cookie('col',sort[0]);
    $.cookie('dir',sort[1]);
  });
<?if ($display['resize']):?>
  resize();
<?endif;?>

$(window).bind('resize',function(){
  resize();
});
  loadList();
<?if (!$dir||$isshare):?>
  $.cookie('dfm_control.common','1');
<?else:?>
  $.removeCookie('dfm_control.common');
<?endif;?>
});
</script>

<div class="autoheight">
  <div class="TableContainer">
    <table class="indexer tablesorter">
      <thead>
        <tr>
          <th><?if($dir){?><i id="check_0" class="fa fa-fw fa-square-o" onclick="selectAll()"></i><?}?></th>
          <th>_(Type)_</th>
          <th class='sorter-text'>_(Name)_</th>
          <th>_(Owner)_</th>
          <th>_(Permission)_</th>
          <th>_(Size)_</th>
          <th>_(Last Modified)_</th>
          <th style="width:200px">_(Location)_</th>
          <th>_(Action)_</th>
        </tr>
      </thead>
    </table>
  </div>
</div>
<div id="buttons">
<input type="button" value="_(Done)_" onclick="done('Browse')">
<input type="button" value="_(Jobs)_" class="dfm_control jobs" onclick="doJobs('_(Scheduled Jobs)_')"<?=$dfm['jobs']?'':' disabled'?>>
<input type="button" value="_(Search)_" class="dfm_control basic" onclick="doActions(15,this.value)"<?=$dfm['running']?' disabled':''?>>
<input type="button" value="_(Delete)_" class="dfm_control extra" onclick="doActions(1,this.value)" disabled>
<input type="button" value="_(Copy)_" class="dfm_control extra" onclick="doActions(3,this.value)" disabled>
<input type="button" value="_(Move)_" class="dfm_control extra" onclick="doActions(4,this.value)" disabled>
<input type="button" value="_(Rename)_" class="dfm_control rename" onclick="doActions(2,this.value)" disabled>
<input type="button" value="_(Owner)_" class="dfm_control extra" onclick="doActions(11,this.value)" disabled>
<input type="button" value="_(Permission)_" class="dfm_control extra" onclick="doActions(12,this.value)" disabled>
<input type="button" value="_(Calculate)_" class="dfm_control extra" onclick="doActions(14,this.value)" disabled>
<input type="button" value="_(Create)_" class="dfm_control common" onclick="doActions(0,this.value)"<?if(!$dir||$isshare){?> disabled<?}?>>
<input type="button" value="_(Upload)_" class="dfm_control common" id="dfm_uploadButton" onclick="$('#dfm_upload').click()"<?if(!$dir||$isshare){?> disabled<?}?>><span id="dfm_uploadStatus"></span>
</div>
