Menu="Main:2"
Title="Pool Devices"
Tag="bullseye"
Cond="($pool_devices || $var['fsState']=='Stopped')"
---
<?PHP
/* Copyright 2005-2023, Lime Technology
 * Copyright 2012-2023, Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>
<?
function makeList($list) {
  return implode(',',array_map('escapestring',$list));
}
function sharename($share) {
  return basename($share,'.cfg');
}
$bootPoolMaxSlots = 2;

if (!function_exists('get_model')) {
  function get_model($id) {
    $id = (string)$id;
    $pos = strrpos($id, '_');
    return $pos === false ? $id : substr($id, 0, $pos);
  }
}

function boot_pool_device_desc($dev) {
  $devId = _var($dev,'id','');
  $devName = _var($dev,'device','');
  $devSectors = _var($dev,'sectors',0);
  $devSectorSize = _var($dev,'sector_size',0);
  $sizeValue = $devSectors > 0 && $devSectorSize > 0 ? ($devSectors * $devSectorSize) : 0;
  $unit = '';
  $sizeText = '';

  if ($sizeValue > 0) {
    if (function_exists('my_scale')) {
      $sizeText = my_scale($sizeValue, $unit, -1);
    } else {
      $sizeText = (string)round($sizeValue / 1024 / 1024);
      $unit = 'MB';
    }
  }

  $label = $devId !== ''
    ? (function_exists('my_id') ? my_id($devId) : $devId)
    : $devName;

  if ($sizeText !== '' && $unit !== '') {
    $label .= " - {$sizeText} {$unit}";
  }
  if ($devName !== '') {
    $label .= " ({$devName})";
  }

  return $label;
}

if (count($devs) > 1) {
  $devSectors = array_column($devs, 'sectors');
  $devModels = array_map('get_model', array_column($devs, 'id'));
  $devDevices = array_column($devs, 'device');
  array_multisort(
    $devSectors, SORT_DESC,
    $devModels, SORT_NATURAL | SORT_FLAG_CASE,
    $devDevices,
    $devs
  );
}
?>
<script>
function validate(poolname) {
  var valid = /^[a-z]([a-z0-9~._-]*[a-z_-])*$/;
  var reserved = [<?=makeList(explode(',',_var($var,'reservedNames')))?>];
  var shares = [<?=makeList(array_map('sharename',glob('boot/config/shares/*.cfg',GLOB_NOSORT)))?>];
  var pools = [<?=makeList($pools)?>];
  if (!poolname.trim()) return false;
  if (reserved.includes(poolname)) {
    swal({title:"_(Invalid pool name)_",text:"_(Do not use reserved names)_",html:true,type:'error',confirmButtonText:"_(Ok)_"});
    return false;
  } else if (shares.includes(poolname)) {
    swal({title:"_(Invalid pool name)_",text:"_(Do not use user share names)_",html:true,type:'error',confirmButtonText:"_(Ok)_"});
    return false;
  } else if (pools.includes(poolname)) {
    swal({title:"_(Invalid pool name)_",text:"_(Pool name already exists)_",html:true,type:'error',confirmButtonText:"_(Ok)_"});
    return false;
  } else if (!valid.test(poolname)) {
    swal({title:"_(Invalid pool name)_",text:"_(Use only lowercase with no special characters or leading/trailing digits)_",type:'error',html:true,confirmButtonText:"_(Ok)_"});
    return false;
  }
  return true;
}
function dialogStyle() {
  $('.ui-dialog-titlebar-close').css({'display':'none'});
  $('.ui-dialog-title').css({'text-align':'center','width':'100%','font-size':'1.8rem'});
  $('.ui-dialog-content').css({'padding-top':'15px','vertical-align':'bottom'});
  $('.ui-button-text').css({'padding':'0px 5px'});
}
function addPoolPopup() {
  var popup = $('#dialogWindow');
  // Load popup with the template info
  popup.html($("#templatePopupPool").html());
  // Start Dialog section
  popup.dialog({
    title: "_(Add Pool)_",
    height: 'auto',
    width: 600,
    resizable: false,
    modal: true,
    buttons: {
    "_(Add)_": function() {
        if (validate($(this).find('input[name="poolName"]').val())) {
          $(this).find('form').submit();
          $(this).dialog('close');
        }
      },
    "_(Cancel)_": function() {
        $(this).dialog('close');
      }
    }
  });
  dialogStyle();
}

function addBootPoolPopup() {
  var popup = $('#dialogWindow');
  // Load popup with the template info
  popup.html($("#templatePopupBootPool").html());
  bootPoolInit(popup);
  // Start Dialog section
  popup.dialog({
    title: "_(Add Bootable Pool)_",
    height: 'auto',
    width: 600,
    resizable: false,
    modal: true,
    buttons: {
    "_(Activate and Reboot)_": function() {
        bootPoolConfirmActivate(popup, true);
      },
    "_(Cancel)_": function() {
        $(this).dialog('close');
      }
    }
  });
  dialogStyle();
}

function bootPoolInit(popup) {
  popup.find('form').on('submit', function(e){
    e.preventDefault();
    return false;
  });
  bootPoolRenderSlots(popup);
  popup.find('select[name="poolSlots"]').on('change', function(){
    bootPoolRenderSlots(popup);
  });
  bootPoolSizeInit(popup);
}

function bootPoolSizeInit(popup) {
  var $select = popup.find('select[name="poolBootSizePreset"]');
  var $input = popup.find('input[name="poolBootSizeCustomGb"]');
  var $hidden = popup.find('input[name="poolBootSize"]');
  var $inputWrap = popup.find('.bootpool-size-custom');
  if (!$select.length || !$input.length || !$hidden.length) return;
  if (!$input.attr('data-default-max')) $input.attr('data-default-max', $input.attr('max') || '');

  function syncBootSize() {
    var val = $select.val();
    if (val === 'custom') {
      $input.prop('readonly', false);
      $inputWrap.removeClass('hidden');
      var gb = parseInt($input.val(), 10);
      var maxGb = parseInt($input.attr('max'), 10);
      if (!isNaN(gb) && gb >= 4) {
        if (!isNaN(maxGb) && maxGb > 0 && gb > maxGb) {
          gb = maxGb;
          $input.val(maxGb);
        }
        $hidden.val(gb * 1024);
      } else {
        $hidden.val('');
      }
    } else {
      $input.prop('readonly', true);
      $inputWrap.addClass('hidden');
      $hidden.val(val);
    }
  }

  var currentMiB = $.trim($hidden.val());
  if (currentMiB && $select.find('option[value="' + currentMiB.replace(/"/g, '\\"') + '"]').length) {
    $select.val(currentMiB);
  } else {
    $select.val('custom');
    if (currentMiB) {
      $input.val(Math.round(parseInt(currentMiB, 10) / 1024));
    }
  }

  $input.on('input change', function(){
    var gb = parseInt($input.val(), 10);
    var maxGb = parseInt($input.attr('max'), 10);
    if (!isNaN(gb) && gb >= 4) {
      if (!isNaN(maxGb) && maxGb > 0 && gb > maxGb) {
        gb = maxGb;
        $input.val(maxGb);
      }
      $hidden.val(gb * 1024);
    } else {
      $hidden.val('');
    }
  });

  $select.on('change', syncBootSize);
  syncBootSize();
  bootPoolUpdateSizeLimits(popup);
}

function bootPoolFormatBootSizeGb(bootSizeMiB) {
  var mib = parseInt(bootSizeMiB, 10);
  if (isNaN(mib) || mib < 0) return "_(Unknown)_";
  if (mib === 0) return "_(Whole drive)_";
  return Math.round(mib / 1024) + " GB";
}

function bootPoolRenderSlots(popup) {
  var slotCount = parseInt(popup.find('select[name="poolSlots"]').val(), 10) || 0;
  var $container = popup.find('#bootPoolDeviceSlots');
  var $sourceWrap = popup.find('#bootPoolDevicesSource');
  if (!$container.length || !$sourceWrap.length) return;
  var $source = $sourceWrap.find('select');
  var existing = {};
  $container.find('select[name="poolDevice[]"]').each(function(){
    var slot = parseInt($(this).attr('data-slot'), 10);
    existing[slot] = $(this).val();
  });
  $container.find('.bootpool-device-row').remove();

  for (var i = 1; i <= slotCount; i++) {
    var $label = $('<dt class="bootpool-device-row"></dt>').text("_(Device)_" + ' ' + i + ':');
    var $dd = $('<dd class="bootpool-device-row"></dd>');
    var $select = $('<select></select>').attr('name','poolDevice[]').attr('data-slot', i);
    $select.append($('<option></option>').attr('value','').text("_(Select device)_"));
    if ($source.length) {
      $source.find('option').each(function(){
        $select.append($(this).clone());
      });
    }
    if (existing[i]) {
      var val = existing[i];
      if ($select.find('option[value="' + val.replace(/"/g, '\\"') + '"]').length) {
        $select.val(val);
      }
    }
    $dd.append($select);
    $container.append($label).append($dd);
  }

  bootPoolSyncDeviceOptions(popup);
  bootPoolUpdateSizeLimits(popup);
  $container.find('select[name="poolDevice[]"]').on('change', function(){
    bootPoolSyncDeviceOptions(popup);
    bootPoolUpdateSizeLimits(popup);
  });
}

function bootPoolUpdateSizeLimits(popup) {
  var $select = popup.find('select[name="poolBootSizePreset"]');
  var $input = popup.find('input[name="poolBootSizeCustomGb"]');
  var $deviceSelects = popup.find('select[name="poolDevice[]"]');
  if (!$select.length || !$input.length) return;

  var defaultMax = parseInt($input.attr('data-default-max'), 10);
  if (isNaN(defaultMax) || defaultMax <= 0) defaultMax = parseInt($input.attr('max'), 10) || 0;

  var minMiB = null;
  $deviceSelects.each(function(){
    var val = $(this).val();
    if (!val) return;
    var sizeMiB = parseInt($(this).find('option:selected').attr('data-size-mib'), 10);
    if (!isNaN(sizeMiB) && sizeMiB > 0) {
      minMiB = (minMiB === null || sizeMiB < minMiB) ? sizeMiB : minMiB;
    }
  });

  var maxMiB = (minMiB !== null) ? Math.floor(minMiB / 2) : null;
  var maxGb = null;
  if (maxMiB !== null) {
    maxGb = Math.floor(maxMiB / 1024);
    if (maxGb < 1) maxGb = 1;
    $input.attr('max', maxGb);
  } else if (defaultMax > 0) {
    $input.attr('max', defaultMax);
  }

  $select.find('option').each(function(){
    var val = $(this).attr('value');
    if (!val || val === 'custom' || val === '0') {
      $(this).prop('hidden', false);
      return;
    }
    var optionMiB = parseInt(val, 10);
    if (maxMiB !== null && !isNaN(optionMiB) && optionMiB > maxMiB) {
      $(this).prop('hidden', true);
    } else {
      $(this).prop('hidden', false);
    }
  });

  var selectedVal = $select.val();
  if (selectedVal && selectedVal !== 'custom' && selectedVal !== '0') {
    var selectedMiB = parseInt(selectedVal, 10);
    if (minMiB !== null && !isNaN(selectedMiB) && selectedMiB >= minMiB) {
      $select.val('0');
      $select.trigger('change');
    } else if (maxMiB !== null && !isNaN(selectedMiB) && selectedMiB > maxMiB) {
      $select.val('custom');
      $select.trigger('change');
    }
  }
  if (maxGb !== null) {
    var currentGb = parseInt($input.val(), 10);
    if (!isNaN(currentGb) && currentGb > maxGb) {
      $input.val(maxGb);
      $input.trigger('change');
    }
  }
}

function bootPoolSyncDeviceOptions(popup) {
  var selected = {};
  popup.find('select[name="poolDevice[]"]').each(function(){
    var val = $(this).val();
    if (val) selected[val] = true;
  });
  popup.find('select[name="poolDevice[]"]').each(function(){
    var current = $(this).val();
    $(this).find('option').each(function(){
      var val = $(this).attr('value');
      if (!val) return;
      if (val === current) {
        $(this).prop('disabled', false);
      } else {
        $(this).prop('disabled', !!selected[val]);
      }
    });
  });
}

function bootPoolCollectDevices(popup) {
  var devices = [];
  popup.find('select[name="poolDevice[]"]').each(function(){
    var slot = parseInt($(this).attr('data-slot'), 10);
    if (!slot || slot < 1) slot = devices.length + 1;
    devices[slot - 1] = $(this).val() || '';
  });
  return devices;
}

function bootPoolValidateSelection(popup) {
  var poolName = $.trim(popup.find('input[name="poolName"]').val());
  if (!validate(poolName)) return null;

  var slotCount = parseInt(popup.find('select[name="poolSlots"]').val(), 10) || 0;
  var devices = bootPoolCollectDevices(popup);
  if (slotCount < 1) {
    swal({title:"_(Invalid selection)_",text:"_(Select at least one device)_",type:'error',html:true,confirmButtonText:"_(Ok)_"});
    return null;
  }
  if (devices.length < slotCount) {
    swal({title:"_(Invalid selection)_",text:"_(Select all devices)_",type:'error',html:true,confirmButtonText:"_(Ok)_"});
    return null;
  }
  var seen = {};
  for (var i = 0; i < slotCount; i++) {
    var val = devices[i];
    if (!val) {
      swal({title:"_(Invalid selection)_",text:"_(Select all devices)_",type:'error',html:true,confirmButtonText:"_(Ok)_"});
      return null;
    }
    if (seen[val]) {
      swal({title:"_(Invalid selection)_",text:"_(Each device must be unique)_",type:'error',html:true,confirmButtonText:"_(Ok)_"});
      return null;
    }
    seen[val] = true;
  }

  var bootSize = $.trim(popup.find('input[name="poolBootSize"]').val());
  if (bootSize === '' || isNaN(parseInt(bootSize, 10))) {
    swal({title:"_(Invalid size)_",text:"_(Select a boot reserved size (minimum 4 GB))_",type:'error',html:true,confirmButtonText:"_(Ok)_"});
    return null;
  }

  return {
    poolName: poolName,
    slotCount: slotCount,
    devices: devices.slice(0, slotCount),
    bootSize: bootSize,
    updateBios: popup.find('input[name="poolUpdateBios"]').is(':checked')
  };
}

function bootPoolConfirmActivate(popup, reboot) {
  var selection = bootPoolValidateSelection(popup);
  if (!selection) return;

  var safePoolName = bootPoolEscapeHtml(selection.poolName);
  var deviceList = '<div style="margin:8px 0 0 0;">';
  for (var i = 0; i < selection.devices.length; i++) {
    deviceList += '<div>' + bootPoolEscapeHtml(selection.devices[i]) + '</div>';
  }
  deviceList += '</div>';

  var cmdArgs = [selection.poolName, selection.bootSize].concat(selection.devices);
  if (reboot) cmdArgs.push('reboot');
  cmdArgs.push('update');
  var cmdPreview = "/plugins/dynamix/scripts/mkbootpool " + cmdArgs.join(' ');

  var title = reboot ? "_(Activate bootable pool and reboot)_?" : "_(Activate bootable pool)_?";
  var biosNote = selection.updateBios
    ? "<br><span style='color:#d00;font-weight:bold;'>_(Some systems may need manual intervention to change boot order in the BIOS)_</span>"
    : "";
  var text = "_(This will create a bootable pool with the selected devices)_" +
    "<br><br><b>_(Pool)_:</b> " + safePoolName +
    "<br><b>_(Boot reserved size)_:</b> " + bootPoolFormatBootSizeGb(selection.bootSize) +
    "<br><b>_(Devices)_:</b>" + deviceList +
    "<br><b>_(Update BIOS boot order)_:</b> " + (selection.updateBios ? "_(Yes)_" : "_(No)_") +
    biosNote +
    "<br><span style='color:#d00;font-weight:bold;'>_(All selected devices will be formatted)_</span>";

  swal({
    title: title,
    text: text,
    type: 'warning',
    html: true,
    showCancelButton: true,
    confirmButtonText: reboot ? "_(Activate and Reboot)_" : "_(Activate)_",
    cancelButtonText: "_(Cancel)_",
    closeOnConfirm: false,
    showLoaderOnConfirm: true,
    allowOutsideClick: false,
    allowEscapeKey: false
  }, function(confirm){
    if (confirm) {
      bootPoolSubmitMkbootpool(popup, selection, reboot);
    }
  });
}

function bootPoolEscapeHtml(text) {
  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function bootPoolRebootNow() {
  var $form = $('#bootPoolRebootForm');
  if (!$form.length) {
    $form = $('<form id="bootPoolRebootForm" method="POST" action="/webGui/include/Boot.php" class="hidden"></form>');
    $('body').append($form);
  }
  $form.find('input[name="cmd"]').remove();
  $form.append('<input type="hidden" name="cmd" value="reboot">');
  $form.submit();
}

function bootPoolSubmitMkbootpool(popup, selection, reboot) {
  var args = [selection.poolName, selection.bootSize].concat(selection.devices);
  if (selection.updateBios) args.push('updatebios');
  if (reboot) args.push('reboot');
  args.push('update');
  popup.dialog('close');
  swal({title:"_(Processing)_...",text:"_(Executing command)_",type:'info',html:true,showConfirmButton:false,allowOutsideClick:false,allowEscapeKey:false});
  $.ajax({
    url: '/plugins/dynamix/include/mkbootpool.php',
    method: 'POST',
    data: {args: args},
    dataType: 'text'
  }).done(function(raw){
    var resp = null;
    try { resp = JSON.parse(raw); } catch (e) { resp = null; }
    var ok = resp && resp.ok;
    var output = resp && resp.output ? resp.output : (raw || "_(No output)_");
    if (ok) {
      if (reboot) {
        swal.close();
        bootPoolRebootNow();
      } else {
        window.location.reload();
      }
      return;
    }
    swal({title:"_(Error)_",text:'<pre style="text-align:left;white-space:pre-wrap;word-wrap:break-word;overflow-wrap:anywhere;font-size:1.0rem;">'+bootPoolEscapeHtml(output)+'</pre>',type:'error',html:true,confirmButtonText:"_(Ok)_",allowOutsideClick:false,allowEscapeKey:false,showCancelButton:false});
  }).fail(function(xhr){
    var text = (xhr && xhr.responseText) ? xhr.responseText : "_(Request failed)_";
    swal({title:"_(Error)_",text:'<pre style="text-align:left;white-space:pre-wrap;word-wrap:break-word;overflow-wrap:anywhere;font-size:1.0rem;">'+bootPoolEscapeHtml(text)+'</pre>',type:'error',html:true,confirmButtonText:"_(Ok)_",allowOutsideClick:false,allowEscapeKey:false,showCancelButton:false});
  });
}
function removeOption(inputString,value) {
  // Define a regular expression to match <option>...</option> substrings
  const optionPattern = /<option .*?<\/option>/g;
  // Replace all matching substrings that contain "value" with an empty string
  const result = inputString.replace(optionPattern, (match) => {
    if (match.includes(value)) {
      return ''; // Remove the entire substring
    } else {
      return match; // Keep the substring as is
    }
  });
  return result;
}
function addSubpoolPopup(poolname,currentsubpools) {
  var popup = $('#dialogWindow');
  // Load popup with the template info
  popup.html($("#templatePopupSubpool").html());
  // Remove the options specifed by currentsubpools
  if (currentsubpools.trim().length !== 0) {
    var subpools = currentsubpools.split(',');
    subpools.forEach(function(subpool) {
      popup.html(function(index, oldHtml) {
        return removeOption(oldHtml, subpool);
      });
    });
  }
  // Start Dialog section
  popup.dialog({
    title: "_(Add ZFS Subpool)_",
    height: 'auto',
    width: 600,
    resizable: false,
    modal: true,
    buttons: {
    "_(Add)_": function() {
        subpool=$(this).find('select[name="subpool"]').val();
        $(this).find('input[name="poolName"]').val(poolname + '<?=$_tilde_?>' + subpool);
        $(this).find('form').submit();
        $(this).dialog('close');
      },
    "_(Cancel)_": function() {
        $(this).dialog('close');
      }
    }
  });
  dialogStyle();
}

<?if (_var($var,'fsState')=="Started"):?>
$('#tab2').bind({click:function() {$('i.toggle').show('slow');}});
<?endif;?>
</script>

<?
// Check for deprecated filesystems using shared function
$deprecatedPools = check_deprecated_filesystems_array($disks, 'cache_filter');
?>


<div class="TableContainer">
<table class="unraid disk_status">
<?$i = 0?>
<?foreach ($pools as $pool):?>
<?if (isset($disks[$pool]['devices']) or _var($var,'fsState')=="Stopped"):?>
<?if (!isSubpool($pool)):
$cache = array_filter(cache_filter($disks),function($disk) use ($pool){return prefix($disk['name'])==$pool;});
$power = _var($display,'power') && in_array('nvme',array_column($cache,'transport')) ? _('Power').' / ' : '';
$root  = explode($_tilde_,$pool)[0];
?>
<?if ($i==0):?>
<thead>
  <tr>
    <td>_(Device)_</td>
    <td>_(Identification)_</td>
    <td><?=$power?>_(Temp)_</td>
    <td>_(Reads)_</td>
    <td>_(Writes)_</td>
    <td>_(Errors)_</td>
    <td>_(FS)_</td>
    <td>_(Size)_</td>
    <td>_(Used)_</td>
    <td>_(Free)_</td>
  </tr>
</thead>
<?else:?>
<thead>
  <tr>
    <td class="divider" colspan="10"></td>
  </tr>
</thead>
<?endif;?>
<?endif;?>
<tbody id="pool_device<?=$i++?>">
<?foreach ($cache as $disk) if (substr($disk['status'],0,7)!='DISK_NP') echo "<tr><td colspan='10'></td></tr>"?>
<?if (_var($display,'total') && _var($cache[$root],'devices',0)>1) echo "<tr class='tr_last'><td colspan='10'></td></tr>"?>
</tbody>
<?endif;?>
<?endforeach;?>
</table>
</div>

<?=display_deprecated_filesystem_warning($deprecatedPools, 'pool')?>

:cache_devices_help:

<?if (_var($var,'fsState')=="Stopped"):?>
<div></div>
:cache_slots_help:
<?endif;?>

<div id="dialogWindow" class="template"></div>
<form id="bootPoolRebootForm" method="POST" action="/webGui/include/Boot.php" class="hidden"></form>

<?if (_var($var,'fsState')=="Stopped"):?>
<input type="button" value="_(Add Pool)_" style="margin:0" onclick="addPoolPopup()">
<?if (_var($var,'bootEligible')=="yes"):?>
<input type="button" value="_(Add Bootable Pool)_" style="margin:0" onclick="addBootPoolPopup()">
<?endif;?>

<div id="templatePopupPool" class="template">
<form markdown="1" method="POST" action="/update.htm" target="progressFrame" onsubmit="return validate(this.poolName.value)">
<input type="hidden" name="changeSlots" value="apply">

_(Name)_:
: <input type="text" name="poolName" maxlength="40" value="<?=count($pools)==0?'cache':''?>">

_(Slots)_:
: <select name="poolSlots">
  <?for ($n=1; $n<=_var($var,'MAX_CACHESZ',0); $n++):?>
  <?=mk_option(1,$n,$n)?>
  <?endfor;?>
  </select>

</form>
</div>

<div id="templatePopupBootPool" class="template">
<form markdown="1" target="progressFrame" >

_(Name)_:
: <input type="text" name="poolName" maxlength="40" value="<?=count($pools)==0?'cache':''?>">

_(Slots)_:
: <select name="poolSlots">
  <?for ($n=1; $n<=$bootPoolMaxSlots; $n++):?>
  <?=mk_option(1,$n,$n)?>
  <?endfor;?>
  </select>

<div id="bootPoolDevicesSource" class="hidden">
  <?if (!empty($devs)):?>
  <select>
    <?foreach ($devs as $dev):?>
    <?
      $devId = _var($dev,'id','');
      $devName = _var($dev,'device','');
      $devSizeMiB = 0;
      $devSectors = _var($dev,'sectors',0);
      $devSectorSize = _var($dev,'sector_size',0);
      if ($devSectors > 0 && $devSectorSize > 0) {
        $devSizeMiB = (int)floor(($devSectors * $devSectorSize) / 1024 / 1024);
      }
      if (trim($devId) !== '') {
        $devValue = $devId;
      } else {
        $devValue = $devName;
      }
      $devLabel = boot_pool_device_desc($dev);
    ?>
    <option value="<?=htmlspecialchars($devValue, ENT_QUOTES, 'UTF-8')?>" data-size-mib="<?=$devSizeMiB?>"><?=htmlspecialchars($devLabel, ENT_QUOTES, 'UTF-8')?></option>
    <?endforeach;?>
  </select>
  <?endif;?>
</div>

<dl id="bootPoolDeviceSlots">
<dt>_(Select devices)_:</dt>
<dd></dd>
</dl>

_(Boot reserved size)_ (_(MiB)_):
: <span><select name="poolBootSizePreset" class="wide bootpool-size-preset" style="max-width: 180px;">
  <option value="16384">16 GB</option>
  <option value="32768">32 GB</option>
  <option value="65536">64 GB</option>
  <option value="131072">128 GB</option>
  <option value="custom">_(User defined)_</option>
  </select>
  <span class="bootpool-size-custom">
    <input type="number" name="poolBootSizeCustomGb" min="4" max="1024" class="narrow" title="_(Minimum is 4 GB; maximum is 50% of the smallest selected drive)_"> GB
  </span><span></span>
  <input type="hidden" name="poolBootSize" value="16384">

_(Update BIOS boot order)_:
: <span><input type="checkbox" name="poolUpdateBios" value="1" checked></span>

<span> </span>
: <span style="color:#d00;font-weight:bold;">_(Some systems may need manual intervention to change boot order in the BIOS)_</span>

<span> </span>
: <span style="color:#d00;font-weight:bold;">_(All selected devices will be formatted)_</span>

</form>
</div>

<div id="templatePopupSubpool" class="template">
<form markdown="1" method="POST" action="/update.htm" target="progressFrame">
<input type="hidden" name="changeSlots" value="apply">
<input type="hidden" name="poolName" value="">

_(Name)_:
: <select name="subpool">
  <?=mk_option("","special",_("special - Metadata storage"))?>
  <?=mk_option("","logs",_("logs - Separate Intent Log (SLOG)"))?>
  <?=mk_option("","dedup",_("dedup - Deduplication Tables"))?>
  <?=mk_option("","cache",_("cache - L2ARC"))?>
  <?=mk_option("","spares",_("spares - Hot Spares"),'disabled')?>
  </select>

_(Slots)_:
: <select name="poolSlots">
  <?for ($n=1; $n<=_var($var,'MAX_CACHESZ',0); $n++):?>
  <?=mk_option(1,$n,$n)?>
  <?endfor;?>
  </select>

</form>
</div>

<?endif;?>
