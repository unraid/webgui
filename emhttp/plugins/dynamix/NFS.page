Menu="NetworkServices:2"
Title="NFS"
Icon="icon-linux"
Tag="linux"
---
<?PHP
/* Copyright 2005-2023, Lime Technology
 * Copyright 2012-2023, Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>

<?
/* Get the current nfs server version and threads count. */
$rpc_nfsd_vers	= trim(exec( "plugins/dynamix/scripts/nfsSettings nfs_version" ));
$rpc_nfsd_count	= trim(exec( "plugins/dynamix/scripts/nfsSettings nfs_count" ))
?>

<script>
function checkNFSenable() {	
  var form = document.nfs_enable;
  form.fuse_remember.disabled = form.shareNFSEnabled.value=="_(no)_";	
}
$(checkNFSenable);
</script>

<form markdown="1" name="nfs_enable" method="POST" action="/update.htm" target="progressFrame">

_(Enable NFS)_:
: <select name="shareNFSEnabled" onchange="checkNFSenable()">
  <?=mk_option($var['shareNFSEnabled'], "no", _('No'));?>
  <?=mk_option($var['shareNFSEnabled'], "yes", _('Yes'));?>
  </select>

> Select 'Yes' to enable the NFS protocol.

_(Tunable (fuse_remember))_:
: <input type="number" name="fuse_remember" maxlength="10" value="<?=$var['fuse_remember']?>" class="narrow">
  <span><?=_($var['fuse_remember_status'])?></span>

> When NFS is enabled, this Tunable may be used to alleviate or solve instances of "NFS Stale File Handles"
> you might encounter with your NFS client.
> 
> In essence, (fuse_remember) tells an internal subsystem (named "fuse") how long to "remember" or "cache"
> file and directory information associated with user shares.  When an NFS client attempts to access a file
> (or directory) on the server, and that file (or directory) name is not cached, then you could encounter
> "stale file handle".
> 
> The numeric value of this tunable is the number of seconds to cache file/directory name entries,
> where the default value of 330 indicates 5 1/2 minutes.  There are two special values you may also set
> this to:
> 
> * 0 which means, do not cache file/directory names at all, and
> * -1 which means cache file/directory names forever (or until array is stopped)
> 
> A value of 0 would be appropriate if you are enabling NFS but only plan to use it for disk shares,
> not user shares.
> 
> A value of -1 would be appropriate if no other timeout seems to solve the "stale file handle" on
> your client.  Be aware that setting a value of -1 will cause the memory footprint to grow by approximately
> 108 bytes per file/directory name cached.  Depending how much RAM is installed in your server and how many
> files/directories you access via NFS this may or may not lead to out-of-memory conditions.

&nbsp;
: <span class="inline-block">
	<input type="submit" name="changeShare" value="_(Apply)_" disabled>
	<input type="button" value="_(Done)_" onclick="done()">
  </span>
</form>

<form markdown="1" name="nfs_settings" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" name="#command" value="/plugins/dynamix/scripts/nfsSettings">
<input type="hidden" name="#arg[1]" value="apply">
<input type="hidden" id="hidden_rpc_nfsd_vers" name="#arg[2]" value="<?=$rpc_nfsd_vers;?>">
<input type="hidden" id="hidden_rpc_nfsd_count" name="#arg[3]" value="<?=$rpc_nfsd_count;?>">

_(Max Server Protocol Version)_:
: <select id="nfs_version" size="1">
  <?=mk_option($rpc_nfsd_vers, "", "_(NFSv4)_");?>
  <?=mk_option($rpc_nfsd_vers, "-N 4", "_(NFSv3)_");?>
  </select>

> Select the max NFS Protocol version you want your Unraid server to support.

_(Number of Threads)_:
: <select id="nfs_threads" size="1">
  <?=mk_option($rpc_nfsd_count, "8", "8");?>
  <?=mk_option($rpc_nfsd_count, "16", "16");?>
  <?=mk_option($rpc_nfsd_count, "32", "32");?>
  <?=mk_option($rpc_nfsd_count, "64", "64");?>
  <?=mk_option($rpc_nfsd_count, "128", "128");?>
  </select>

> Set the number of threads for NFS.  For light NFS loads, 8 is sufficient. For heaver NFS loads, a higher number of threads might be appropriate.
> 
> If there aren't enough threads, NFS will probably crash.

&nbsp;
: <span class="inline-block">
	<input type="submit" value="_(Apply)_" disabled>
	<input type="button" value="_(Done)_" onclick="done()">
  </span>
</form>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		/* Get references to the dropdowns and hidden inputs. */
		const nfsServerVersion = document.getElementById('nfs_version');
		const nfsThreads = document.getElementById('nfs_threads');
		const hiddenRpcNfsdVers = document.getElementById('hidden_rpc_nfsd_vers');
		const hiddenRpcNfsdCount = document.getElementById('hidden_rpc_nfsd_count');

		/* Check if elements exist. */
		if (nfsServerVersion && nfsThreads && hiddenRpcNfsdVers && hiddenRpcNfsdCount) {
			/* Update hidden inputs when the dropdowns change. */
			nfsServerVersion.addEventListener('change', function () {
				hiddenRpcNfsdVers.value = this.value;
			});

			nfsThreads.addEventListener('change', function () {
				hiddenRpcNfsdCount.value = this.value;
			});
		}
	});
</script>
