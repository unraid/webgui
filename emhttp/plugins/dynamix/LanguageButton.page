Menu="Buttons:1"
Title="Switch Language"
Icon="flag"
Code="e982"
---
<?PHP
/* Copyright 2005-2023, Lime Technology
 * Copyright 2012-2023, Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */

// Scan /usr/local/emhttp/languages for available language directories
$languagesDir = '/usr/local/emhttp/languages';
$availableLanguages = [];
$currentLocale = $locale ?? '';

if (is_dir($languagesDir)) {
  $dirs = glob($languagesDir . '/*', GLOB_ONLYDIR);
  foreach ($dirs as $dir) {
    $langName = basename($dir);
    if ($langName && $langName !== 'en_US') {
      // Skip en_US since it's the default
      // Check for language.txt file in the directory
      $languageFile = $dir . '/language';
      $displayName = $langName; // Default to directory name
      
      if (file_exists($languageFile)) {
        $fileContent = trim(file_get_contents($languageFile));
        if (!empty($fileContent)) {
          $displayName = $fileContent;
        }
      }
      
      $availableLanguages[] = [
        'code' => $langName,
        'name' => $displayName
      ];
    }
  }
  // Sort by country code
  usort($availableLanguages, function($a, $b) {
    return strcmp($a['code'], $b['code']);
  });
  
  // Separate current locale from others
  $currentLanguage = null;
  $otherLanguages = [];
  foreach ($availableLanguages as $lang) {
    if ($lang['code'] === $currentLocale) {
      $currentLanguage = $lang;
    } else {
      $otherLanguages[] = $lang;
    }
  }
  // Rebuild array with current first, then others
  $availableLanguages = [];
  if ($currentLanguage) {
    $availableLanguages[] = $currentLanguage;
  }
  $availableLanguages = array_merge($availableLanguages, $otherLanguages);
}

// Hide button if no languages found
if (empty($availableLanguages)):?>
<style>
.nav-item.LanguageButton{display:none}
</style>
<?endif;?>

<style>
.language-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 10000;
  display: none;
  justify-content: center;
  align-items: center;
}
.language-modal {
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 5px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  min-width: 300px;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
}
.language-modal-header {
  padding: 15px 20px;
  border-bottom: 1px solid #e5e5e5;
  font-size: 1.6rem;
  font-weight: bold;
  background-color: #f5f5f5;
  border-radius: 5px 5px 0 0;
}
.language-modal-close {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 2rem;
  line-height: 1;
  color: #999;
  cursor: pointer;
  border: none;
  background: none;
  padding: 0;
  width: 24px;
  height: 24px;
}
.language-modal-close:hover {
  color: #333;
}
.language-modal-body {
  padding: 10px 0;
}
.language-modal-list {
  list-style: none;
  margin: 0;
  padding: 0;
}
.language-modal-item {
  margin: 0;
  padding: 0;
}
.language-modal-item a {
  display: block;
  padding: 10px 20px;
  color: #303030;
  text-decoration: none;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
}
.language-modal-item a:hover {
  background-color: #f5f5f5;
}
.language-modal-item a.active {
  background-color: #0088cc;
  color: #ffffff;
  font-weight: bold;
}
.language-modal-item:last-child a {
  border-bottom: none;
}
</style>

<?
// Build modal HTML in PHP
// Start with current language if it exists
$modalItems = '';
if ($currentLocale && !empty($availableLanguages) && $availableLanguages[0]['code'] === $currentLocale) {
  $lang = $availableLanguages[0];
  $langCodeEscaped = htmlspecialchars($lang['code'], ENT_QUOTES, 'UTF-8');
  $langNameEscaped = htmlspecialchars($lang['name'], ENT_QUOTES, 'UTF-8');
  $displayText = $langCodeEscaped . ' - ' . $langNameEscaped;
  $modalItems .= '<li class="language-modal-item"><a href="#" data-lang="'.$langCodeEscaped.'" class="active">'.$displayText.'</a></li>';
  // Remove current from the list for the rest
  $remainingLanguages = array_slice($availableLanguages, 1);
} else {
  $remainingLanguages = $availableLanguages;
}

// Add default option (active if no locale or en_US)
$defaultActive = (empty($currentLocale) || $currentLocale === 'en_US') ? 'active' : '';
$modalItems .= '<li class="language-modal-item"><a href="#" data-lang="" class="'.$defaultActive.'">Default (English)</a></li>';

// Add remaining languages
foreach ($remainingLanguages as $lang) {
  $langCodeEscaped = htmlspecialchars($lang['code'], ENT_QUOTES, 'UTF-8');
  $langNameEscaped = htmlspecialchars($lang['name'], ENT_QUOTES, 'UTF-8');
  $displayText = $langCodeEscaped . ' - ' . $langNameEscaped;
  $modalItems .= '<li class="language-modal-item"><a href="#" data-lang="'.$langCodeEscaped.'">'.$displayText.'</a></li>';
}
?>

<div class="language-modal-overlay" id="language-modal-overlay">
  <div class="language-modal">
    <div class="language-modal-header">
      Select Language
      <button class="language-modal-close" onclick="closeLanguageModal()">&times;</button>
    </div>
    <div class="language-modal-body">
      <ul class="language-modal-list">
        <?=$modalItems?>
      </ul>
    </div>
  </div>
</div>

<script>
var languageButtonProcessing = false;

// Override onclick handler on page load
$(document).ready(function() {
  // Remove the original onclick attribute and override with our handler
  var $link = $('.nav-item.LanguageButton a');
  $link.removeAttr('onclick');
  $link.off('click').on('click', function(e) {
    e.preventDefault();
    e.stopImmediatePropagation();
    e.stopPropagation();
    
    // Prevent double execution
    if (languageButtonProcessing) {
      return false;
    }
    languageButtonProcessing = true;
    
    setTimeout(function() {
      languageButtonProcessing = false;
    }, 300);
    
    LanguageButton();
    return false;
  });
});

function LanguageButton() {
  var modal = $('#language-modal-overlay');
  if (modal.length === 0) {
    console.error('Language modal not found in DOM');
    return false;
  }
  
  // Check if modal is currently visible
  var isVisible = modal.css('display') === 'flex' || modal.is(':visible');
  
  if (isVisible) {
    closeLanguageModal();
  } else {
    modal.css('display', 'flex');
    // Ensure it stays visible
    setTimeout(function() {
      if (modal.css('display') !== 'flex') {
        modal.css('display', 'flex');
      }
    }, 10);
  }
  return false;
}

function closeLanguageModal() {
  $('#language-modal-overlay').css('display', 'none');
}

function switchLanguage(lang) {
  var currentLang = '<?=$currentLocale?>';
  
  // reset dashboard tiles when switching language
  if (lang != currentLang) {
    $.removeCookie('db-box1');
    $.removeCookie('db-box2');
    $.removeCookie('db-box3');
    $.removeCookie('inactive_content');
    $.removeCookie('hidden_content');
  }
  
  $.post('/webGui/include/LanguageReset.php',{lang:lang},function(){setTimeout(function(){location.reload();},1000);});
}

// Close modal when clicking on overlay (but not on modal itself)
$(document).on('click', '#language-modal-overlay', function(e) {
  // Only close if clicking directly on the overlay, not on the modal content
  if ($(e.target).is('#language-modal-overlay')) {
    closeLanguageModal();
  }
});

// Handle language selection
$(document).on('click', '.language-modal-item a', function(e) {
  e.preventDefault();
  e.stopPropagation();
  var lang = $(this).data('lang') || '';
  var currentLang = '<?=$currentLocale?>';
  
  // If clicking the currently selected language, just close the modal
  if (lang === currentLang || (lang === '' && (currentLang === '' || currentLang === 'en_US'))) {
    closeLanguageModal();
    return;
  }
  
  closeLanguageModal();
  switchLanguage(lang);
});
</script>